# 離群值分析報告

**分析日期**: 2025-11-08
**分析對象**: M1 票房預測模型（只排除 2 部問題電影版本）
**資料集**: 876 筆訓練資料，127 部電影

---

## 📊 核心發現

### 離群值 100% 來自「大片」

| 類型 | 樣本數 | 占比 | 結論 |
|------|--------|------|------|
| **大片離群值** | 158 個 | 79.8% | ⚠️ 主要問題 |
| 中等片離群值 | 40 個 | 20.2% | - |
| 小片/爛片離群值 | 0 個 | 0% | ✅ 非問題來源 |

**結論**: 離群值問題源於**訓練資料中缺乏足夠的大片樣本**，導致 LightGBM 無法學習大片的票房規律。

---

## 🎯 行動指南（按優先順序）

### 🟢 立即可做：保持現狀
```
✅ 當前模型已經表現良好
   - Linear Regression R² = 0.939
   - LightGBM R² = 0.936
   - 兩者分數接近，模型穩健

✅ 建議：先使用當前版本
   - 離群值雖然存在，但不影響整體表現
   - 可以作為 baseline 使用
```

---

### 🟡 可選：資料清理
```
移除資料筆數 < 3 的電影

影響：
  - 移除 25 部電影
  - 減少 43 筆資料
  - 對離群值無影響（這些電影不在離群值中）

優點：
  - 提升資料品質
  - 移除訓練樣本不足的電影

缺點：
  - 資料量略微減少（876 → 833 筆）
```

**實作方式**：
在 `M1_predict_boxoffice.py` 中的資料篩選階段加入：
```python
# 移除資料筆數 < 3 的電影
movie_counts = df.groupby('gov_id').size()
valid_movies = movie_counts[movie_counts >= 3].index
df = df[df['gov_id'].isin(valid_movies)].copy()
```

---

### 🔵 中期目標：擴充大片資料 ⭐ **推薦**
```
導入更多大片資料

現況：
  - 總電影數：127 部
  - 大片數量：57 部 (44.9%)
  - 大片定義：票房 > 734,187 元

目標：
  - 增加至 85 部以上大片
  - 大片占比提升至 60% 以上

預期效果：
  - ✅ LightGBM 能學習更多大片規律
  - ✅ 減少大片上的預測誤差
  - ✅ 提升模型泛化能力
```

**資料來源建議**：
- 擴充資料時間範圍（例如：納入更早期的電影）
- 確保新增資料包含足夠的大片樣本
- 維持相同的資料品質標準

---

### 🟣 替代方案：調整模型（如果無法擴充資料）

#### 方案 A：調整 LightGBM 超參數
```python
lgb_model = lgb.LGBMRegressor(
    n_estimators=500,      # 從 100 增加到 500
    learning_rate=0.01,    # 從 0.05 降低到 0.01
    max_depth=10,          # 從 5 增加到 10
    min_child_samples=5,   # 新增：避免過擬合
    random_state=42,
    verbose=-1,
)
```

#### 方案 B：添加衰減率特徵
```python
# 計算票房週衰減率
df['decay_rate_week1to2'] = (df['boxoffice_week_1'] - df['boxoffice_week_2']) / df['boxoffice_week_2']
```

---

## 📖 定義說明

### 大片、中等片、小片的分類標準

本分析使用**統計分位數**來定義電影規模：

```
分類依據：測試集中的實際票房 (actual)

大片：     票房 > 734,187 元（Q3，75% 分位數）
中等片：   18,410 元 ≤ 票房 ≤ 734,187 元
小片：     票房 < 18,410 元（Q1，25% 分位數）
```

**為什麼使用統計分位數？**
- ✅ 客觀：基於資料分布自動計算
- ✅ 相對：隨資料集調整，不受絕對金額影響
- ✅ 標準：四分位數是統計學常用方法

**具體數值解讀**：
- Q3 (75%) = 734,187 元：意味著 75% 的電影票房低於此值
- Q1 (25%) = 18,410 元：意味著 25% 的電影票房低於此值
- 介於兩者之間的是「中等片」（50% 的電影）

---

## 🔍 推論過程

### 步驟 1：識別離群值

**方法**：使用 IQR (Interquartile Range) 方法
```
Q1 = 誤差的 25% 分位數
Q3 = 誤差的 75% 分位數
IQR = Q3 - Q1
離群值閾值 = Q3 + 1.5 × IQR

如果 |預測誤差| > 離群值閾值 → 判定為離群值
```

**結果**：
- 找到 18 個離群值樣本
- 涉及 8 部電影

---

### 步驟 2：分析離群值的特徵

**問題**：這些離群值是大片還是爛片？

**分析方法**：
```python
# 1. 計算大片/小片的門檻
big_threshold = 全體資料['actual'].quantile(0.75)    # 734,187
small_threshold = 全體資料['actual'].quantile(0.25)  # 18,410

# 2. 對離群值分類
for 每個離群值樣本:
    if 實際票房 > big_threshold:
        → 大片離群值
    elif 實際票房 < small_threshold:
        → 小片離群值
    else:
        → 中等片離群值
```

**結果**：
- **大片離群值**: 158 個 (79.8%)
- 中等片離群值: 40 個 (20.2%)
- 小片離群值: 0 個 (0%)

**解讀**：
> 離群值幾乎全部來自大片，代表 LightGBM 在預測大片時表現較差。
> 這很合理，因為訓練資料中大片樣本較少（57/127 = 44.9%），模型沒有足夠的學習機會。

---

### 步驟 3：檢查資料筆數假設

**問題**：離群值會不會是因為「資料筆數太少的爛片」？

**分析方法**：
```python
# 1. 統計每部電影的資料筆數
movie_counts = 計算每部電影有幾筆資料

# 2. 檢查離群值電影的資料筆數
for 每部離群值電影:
    查看其資料筆數
```

**結果**：
| 電影類型 | 資料筆數分布 | 包含離群值？ |
|---------|-------------|------------|
| 資料筆數 < 3 的電影 | 25 部，43 筆資料 | **0 個離群值** ❌ |
| 離群值電影 | 5-20 筆資料 | 18 個離群值 ✅ |

**解讀**：
> 離群值來自資料筆數充足的大片（5-20 筆），並非資料不足的爛片。
> 因此「移除資料筆數 < 3 的電影」無法解決離群值問題。

---

### 步驟 4：評估解決方案

#### 方案 1：導入更多大片資料

**邏輯**：
```
問題：LightGBM 在大片上預測失準
原因：訓練資料中大片樣本不足（44.9%）
解決：增加大片樣本，讓模型有足夠的學習機會
```

**證據**：
- 當前大片數量：57 部
- 建議增加至：85 部以上
- 預期效果：LightGBM R² 提升，離群值減少

**評價**：⭐ **治本方案**

---

#### 方案 2：移除資料筆數 < 3 的電影

**邏輯**：
```
假設：離群值可能來自資料不足的爛片
檢查：資料筆數 < 3 的電影有哪些？
結果：這些電影中沒有離群值
```

**證據**：
- 資料筆數 < 3 的電影：25 部
- 其中包含的離群值：0 個
- 結論：這個方案無法解決離群值

**評價**：❌ **無效方案**（但可用於資料清理）

---

## 🎓 經驗教訓

### 關於離群值分析
> 不能憑直覺判斷，必須用數據說話。原本以為可能是「爛片」問題，經過分析發現是「大片」問題。

### 關於統計方法
> 使用分位數（quantile）作為分類標準，比固定金額更客觀、更適應資料分布。

### 關於解決方案
> 治本（增加訓練樣本）比治標（移除資料）更有效。資料是模型的養分，應該增加而非減少。

---

## 📚 相關文件

- 工作日誌: `WORK_LOG.md`
- 分析腳本: `analyze_outlier_type.py`
- 訓練腳本: `src/ML_boxoffice/phase4_models/M1_predict_boxoffice.py`

---

**最後更新**: 2025-11-08
