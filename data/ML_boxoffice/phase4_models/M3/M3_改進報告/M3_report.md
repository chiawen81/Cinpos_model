# M3 模型測試報告

**日期**：2025-11-09
**版本**：M3 (測試集排除大片實驗)
**比較基準**：M1 / M2
**實驗目的**：驗證離群值是否來自大片樣本

---

## 📋 1. 調整內容（與 M1 相比）

### 實驗設計

M3 是一個**控制實驗**，用於驗證假設：

**假設**：散佈圖中的離群值主要來自「大片」樣本，如果排除這些大片，離群值會消失。

### 主要變更

| 項目 | M1/M2 版本 | M3 版本 | 變更原因 |
|------|-----------|---------|----------|
| **訓練資料** | 完整訓練集 | ✅ **相同**（保持不變） | 確保公平比較 |
| **測試資料** | 完整測試集 | ⭐ **過濾後的測試集** | 排除大片樣本 |
| **模型數量** | 2 個 | **3 個** | 全面比較 |
| **評估方式** | 標準評估 | 在過濾後的測試集上評估 | 觀察離群值變化 |

### 三模型配置

M3 同時訓練三個模型進行比較：

1. **Linear Regression**：基準模型
2. **LightGBM**：Ensemble 模型（梯度提升）
3. **Decision Tree**：單棵決策樹

**訓練方式**：所有模型都在**完整訓練集**上訓練
**評估方式**：在**過濾後的測試集**上評估

---

## 🎯 2. 測試目的

### 研究問題

在 M1 和 M2 的散佈圖中，我們觀察到：
- Linear Regression 和 Tree-based 模型都存在離群值
- 這些離群值可能是高票房的「大片」電影

### 測試假設

**假設 H1**：離群值主要來自測試集中的大片樣本

**預期結果**：
- ✅ 如果假設正確：排除大片後，離群值消失，R² 分數應**提升**或**維持**
- ❌ 如果假設錯誤：排除大片後，R² 分數**下降**，離群值依然存在

### 過濾設定

為了驗證假設，我們設定：

```python
FILTER_COLUMN = "amount"          # 基準：最終票房
PERCENTILE_THRESHOLD = 95         # 排除前 5% 的大片
EXCLUDE_WHOLE_MOVIE = True        # 刪除整部電影的所有週次
```

**過濾邏輯**：
1. 計算測試集中 `amount` 的第 95 百分位數
2. 找出所有超過此閾值的樣本
3. 將這些樣本所屬的**整部電影**從測試集移除
4. 在過濾後的測試集上評估模型

---

## 📊 3. 測試結果

### 🔴 關鍵發現：實驗結果與預期相反！

| 模型 | M1/M2 (完整測試集) | M3 (排除大片) | 變化 | 結果 |
|------|-------------------|--------------|------|------|
| Linear Regression | 0.939 | **-1.001** | -1.940 | ❌ 崩潰 |
| LightGBM | 0.936 | **-0.567** | -1.503 | ❌ 崩潰 |
| Decision Tree | 0.892 | **0.440** | -0.452 | ❌ 大幅下降 |

### ⚠️ 異常現象分析

#### 1. 負的 R² 分數

**Linear Regression R² = -1.001** 和 **LightGBM R² = -0.567** 出現了**負值**！

**R² 分數的意義**：
```
R² = 1 - (SS_res / SS_tot)

其中：
- SS_res = Σ(y_actual - y_pred)²   # 殘差平方和
- SS_tot = Σ(y_actual - y_mean)²   # 總平方和
```

**負的 R² 表示**：
- 模型的預測**比單純預測平均值還差**
- SS_res > SS_tot，即預測誤差超過目標變數的總變異
- **模型完全失效**

#### 2. Decision Tree 大幅下降

Decision Tree 的 R² 從 0.892 降到 0.440，下降了 **0.452**

這表示：
- 模型只能解釋 44% 的變異（原本是 89.2%）
- 預測能力大幅降低

### 視覺化結果分析

根據提供的散佈圖：

**Linear Regression (藍色)**：
- 預測點嚴重偏離對角線
- 大量樣本的預測值遠低於實際值
- 呈現系統性的**低估**現象

**LightGBM (綠色)**：
- 預測分布非常分散
- 沒有明顯的線性關係
- 模型無法捕捉票房規律

**Decision Tree (橙色)**：
- 雖然 R² 仍為正值 (0.440)
- 但預測誤差明顯增大
- 階梯狀分布更加明顯

### 測試集統計資訊

根據過濾設定（排除前 5% 大片），測試集變化：

**預期**：
- 原始測試集約 176 筆（假設）
- 排除約 9 筆大片樣本（5%）
- 過濾後約 150-160 筆

**實際影響**：
- 由於 `EXCLUDE_WHOLE_MOVIE = True`
- 整部電影的所有週次都被移除
- 實際減少的樣本數可能更多

---

## 🔍 4. 深入分析

### 為什麼排除大片會讓模型崩潰？

#### 原因 1：訓練集與測試集分布嚴重不匹配 ⭐⭐⭐

**問題核心**：
- 模型在**完整訓練集**上學習（包含大片）
- 但在**排除大片的測試集**上評估

**結果**：
```
訓練集票房範圍: [210 元 ~ 150,000,000 元]
測試集票房範圍: [210 元 ~ 12,000,000 元]  ← 移除了高票房樣本

模型學習的規律無法應用於這個「人工縮減」的測試集
```

#### 原因 2：特徵與目標的關係被扭曲

假設模型學到的規律：
```
票房 = f(第一週票房, 廳數, 觀眾數, ...)
```

在訓練時：
- 模型見過「第一週票房 5000萬 → 總票房 1.5億」的樣本
- 學到了大片的票房衰減規律

在測試時（排除大片後）：
- 測試集中沒有總票房 > 1200萬的樣本
- 但可能有「第一週票房很高」的特徵值
- 模型按照學到的規律預測出高票房
- 但實際值被人為限制在較低範圍
- **產生巨大的預測誤差**

#### 原因 3：樣本數減少 + 分布改變

排除整部電影（`EXCLUDE_WHOLE_MOVIE = True`）會導致：
- 測試集樣本數大幅減少
- 可能只剩下「小片」和「中等片」
- 這些樣本的票房規律可能與大片不同
- 模型在這個子集上的表現不具代表性

---

## 💡 5. 結論與發現

### 🎯 主要結論

❌ **實驗假設被證明錯誤**

**原假設**：離群值主要來自大片樣本，排除大片可改善模型表現

**實驗結果**：排除大片後，模型表現**大幅惡化**

### 💡 重要發現

#### 發現 1：大片不是問題，是正常的數據分布 ⭐⭐⭐

工作日誌中的觀點得到驗證：

> 「大片不是離群值，它們是正常的數據分布。只有資料異常的樣本才是真正的離群值。」

**證據**：
- 模型在包含大片的完整測試集上表現優秀（R² ≈ 0.93）
- 排除大片後模型崩潰（R² 變負）
- 這證明大片是模型正常學習的一部分

#### 發現 2：訓練集與測試集分布必須一致 ⭐⭐⭐

這是機器學習的基本原則：

**正確做法**：
```
訓練集：完整分布（包含所有類型電影）
測試集：完整分布（包含所有類型電影）
評估：模型在完整分布上的表現
```

**錯誤做法**（M3 的問題）：
```
訓練集：完整分布（包含大片）
測試集：人工縮減分布（排除大片）
評估：無意義的評估結果 ❌
```

#### 發現 3：離群值來自模型本身的限制

既然大片不是問題，那離群值來自哪裡？

**可能原因**：
1. **特徵不足**：某些影響票房的因素未被納入（如口碑、競爭對手）
2. **模型假設**：Linear Regression 假設線性關係，但實際可能是非線性
3. **資料品質**：某些樣本的特徵值可能有誤差
4. **時間效應**：不同年份的市場環境不同

---

## 📌 6. 建議與啟示

### ✅ 正確的離群值處理方式

#### 方法 1：分析具體電影，找出資料異常

```python
# 找出預測誤差最大的電影
large_errors = results[abs(results['error_lr']) > threshold]

# 逐一檢查這些電影：
# - 是否有資料錄入錯誤？
# - 是否有特殊情況（如重映、特殊檔期）？
# - 是否屬於特殊類型（如紀錄片、藝術片）？
```

**範例**（從工作日誌）：
- `31082` 地球特派員：首輪上映票房異常 → **應排除**
- `22894` 一一：資料汙染 → **應排除**
- `31123` 侏羅紀世界：正常的大片 → **不應排除**

#### 方法 2：分層建模

如果大片和小片確實有不同規律：

```python
# 訓練兩個模型
model_blockbuster = train(data[data['type'] == 'blockbuster'])
model_regular = train(data[data['type'] == 'regular'])

# 預測時選擇對應模型
if is_blockbuster(movie):
    prediction = model_blockbuster.predict(features)
else:
    prediction = model_regular.predict(features)
```

#### 方法 3：特徵工程

添加更多特徵，幫助模型理解大片：

```python
# 大片指標
features['is_major_release'] = (features['screens_week_1'] > 200)
features['opening_intensity'] = features['boxoffice_week_1'] / features['screens_week_1']

# 衰減率
features['decay_rate'] = (features['boxoffice_week_1'] - features['boxoffice_week_2']) / features['boxoffice_week_2']
```

### ❌ 不應該做的事

1. ❌ **不要在測試集上人為過濾樣本**（除非有明確理由）
2. ❌ **不要因為「票房高」就認為是離群值**
3. ❌ **不要追求單一模型的高 R²**，而忽略模型一致性

---

## 📊 7. 實驗價值

雖然 M3 的結果是「負面」的，但這次實驗仍然非常有價值：

### ✅ 驗證了重要假設

- 證明了工作日誌中的觀點是正確的
- 避免了未來犯同樣的錯誤

### ✅ 學到了重要教訓

**教訓 1**：不要隨意過濾測試集
**教訓 2**：大片是正常的數據分布，不應排除
**教訓 3**：離群值問題需要更仔細的分析

### ✅ 提供了改進方向

- 分層建模
- 特徵工程
- 逐一檢查異常樣本

---

## 📎 附錄

### A. 彈性過濾控制功能

M3 實作了完整的過濾控制系統：

```python
# 1️⃣ 選擇過濾基準欄位
FILTER_COLUMN = "amount"  # 可選: "amount", "boxoffice_week_1", 等

# 2️⃣ 選擇百分位數閾值
PERCENTILE_THRESHOLD = 95  # 排除前 5%

# 3️⃣ 是否刪除整部電影
EXCLUDE_WHOLE_MOVIE = True  # 刪除整部電影的所有週次

# 4️⃣ 或使用絕對閾值
# ABSOLUTE_THRESHOLD = 10_000_000
```

### B. 安全機制

程式會自動檢查：
```python
if len(X_test_filtered) < 30:
    print("⚠️ 警告: 測試集樣本數過少，模型評估可能不穩定！")
```

### C. 輸出檔案

```
data/ML_boxoffice/phase4_models/M3_YYYYMMDD_HHMMSS/
├── training_log_YYYYMMDD_HHMMSS.txt
├── prediction_comparison.png        # 三模型比較
├── test_predictions.csv
├── excluded_samples.csv             # 被排除的樣本
├── excluded_movies_summary.csv      # 被排除的電影統計
├── model_summary.csv                # 三模型表現總結
├── model_linear_regression.pkl
├── model_lightgbm.pkl
└── model_decision_tree.pkl
```

### D. 程式碼位置

- **M3 主腳本**：`src/ML_boxoffice/phase4_models/M3_predict_boxoffice.py`
- **過濾邏輯**：第 229-335 行
- **三模型訓練**：第 352-427 行

---

## 🎓 8. 經驗總結

### 給未來自己的提醒

**當發現離群值時**：
1. ✅ 先檢查是否為資料錯誤
2. ✅ 分析具體是哪些樣本
3. ✅ 理解這些樣本的業務意義
4. ❌ 不要急著過濾或排除

**當測試模型時**：
1. ✅ 確保訓練集與測試集分布一致
2. ✅ 保持評估的公平性
3. ✅ 重視模型一致性（多模型 R² 接近）
4. ❌ 不要人為操作測試集

**當模型表現不佳時**：
1. ✅ 考慮特徵工程
2. ✅ 考慮分層建模
3. ✅ 考慮更複雜的模型
4. ❌ 不要嘗試「隱藏」問題樣本

---

**報告撰寫日期**：2025-11-09
**撰寫者**：Claude Code AI Assistant

**實驗結論**：M3 雖然沒有達到預期效果，但證明了「大片不是問題」的重要觀點，為後續研究指明了正確方向。
