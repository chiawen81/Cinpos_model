# 電影票房預測 - 資料字典

> **版本**: 1.0  
> **更新日期**: 2024-01-XX  
> **用途**: 定義訓練資料的所有欄位，供 AI Agent 和開發者參考

---

## 資料結構概述

### 訓練資料格式
- **每一 row**: 代表一個預測樣本
- **預測目標**: 當週票房（target_boxoffice）
- **特徵來源**: 前兩週的歷史資料 + 累積資訊 + 開片實力
- **時間範圍**: 當週之前的所有資訊（不含當週結果）

### 關鍵概念
1. **當週**: 訓練時=已知週次，預測時=要預測的週次
2. **真實週次**: 輪內連續編號（1, 2, 3...），不跳號
3. **活躍週次**: 去除票房=0的週次後重新編號
4. **累積資訊**: 一律截至上週，不包含當週

---

## 欄位定義

### 1. 基本資訊 (3 欄位)

#### movie_id
- **類型**: string
- **說明**: 電影唯一識別碼
- **範例**: "M12345", "AVATAR2023"
- **用途**: 識別電影，用於分組和追蹤
- **注意**: 不用於模型訓練（識別碼）

#### round_idx
- **類型**: integer
- **說明**: 當週所屬的輪次編號
- **取值範圍**: 1, 2, 3, 4, 5...
- **定義**: 
  - 1 = 首輪
  - 2 = 次輪
  - 3 = 三輪...
- **輪次判定規則**: 
  - **輪次結束條件**: 連續 3 週票房 = 0 視為該輪結束
  - **輪次成立條件**: 
    - 真實週次（含輪內票房為0的週次）≥ 3 週
    - 活躍週次（僅計票房>0的週次）≥ 3 週
    - 輪次的最後一週必須有票房（末尾連續票房=0的週次會被移除）
  - **輪次容忍中斷**: 輪次內允許最多連續 2 週票房 = 0（這些週次會保留但不計入活躍週次）
- **資料過濾**:
  - 正式上映日之前的週次不計入任何輪次
  - 不符合成立條件的輪次會被整輪刪除
- **用途**: 
  - 模型特徵（首輪 vs 次輪衰減模式不同）
  - 分輪次建模的依據

#### rounds_cumsum
- **類型**: integer
- **說明**: 該電影已知的累計輪次數
- **取值範圍**: 1-5
- **範例**: 
  - 首輪電影 = 1
  - 次輪電影 = 2
- **用途**: 反映電影的生命週期長度

---

### 2. 當週時間資訊 (4 欄位)

#### current_week_real_idx
- **類型**: integer
- **說明**: 當輪當週的真實週次（輪內連續編號）
- **取值範圍**: 1-52
- **編號規則**: 每輪重新從 1 開始，連續編號
- **範例**:
  - 首輪第 5 週 → current_week_real_idx = 5
  - 次輪第 3 週 → current_week_real_idx = 3
- **注意**: 這是「輪內週次」，不是從首輪第 1 週開始算
- **用途**: 反映當前在該輪的生命週期階段

#### current_week_active_idx
- **類型**: integer
- **說明**: 當輪當週的活躍週次（去除票房=0後重編）
- **取值範圍**: 1-52
- **編號規則**: 砍掉票房=0的週次，剩餘週次重新編號
- **範例**:
```
  真實週次: 1, 2, 3, 5, 6  (第4週票房=0，被砍掉)
  活躍週次: 1, 2, 3, 4, 5  (重新連續編號)
```
- **用途**: 反映實際連續上映的週次

#### gap_real_week_2to1
- **類型**: integer
- **說明**: week_-2 到 week_-1 之間跳過的週次數
- **取值範圍**: 0-5
- **計算公式**: `(week_-1 真實週次) - (week_-2 真實週次) - 1`
- **範例**:
  - week_-2 在真實第 2 週，week_-1 在真實第 3 週 → gap = 0（無跳週）
  - week_-2 在真實第 2 週，week_-1 在真實第 5 週 → gap = 2（跳了第 3, 4 週）
- **用途**: 標記近期是否有中斷上映

#### gap_real_week_1tocurrent
- **類型**: integer
- **說明**: week_-1 到當週之間跳過的週次數
- **取值範圍**: 0-5
- **計算公式**: `(當週真實週次) - (week_-1 真實週次) - 1`
- **用途**: 標記當週前是否有中斷

---

### 3. 近期趨勢 (9 欄位)

#### boxoffice_week_2
- **類型**: float
- **單位**: 萬元（新台幣）
- **說明**: 兩週前的票房
- **取值範圍**: 0-50000
- **時間點**: 當週的前第 2 個活躍週
- **用途**: 反映近期票房趨勢

#### boxoffice_week_1
- **類型**: float
- **單位**: 萬元
- **說明**: 上週票房
- **時間點**: 當週的前第 1 個活躍週
- **用途**: 最重要的近期趨勢特徵

#### boxoffice_week_1_PR
- **類型**: float
- **取值範圍**: 0-100
- **說明**: 上週票房的百分位排名（PR, Percentile Rank）
- **計算方式**: 按「年份 × 輪次」分組計算
```python
  df.groupby(['release_year', 'round_idx'])['boxoffice_week_1'].rank(pct=True) * 100
```
- **解讀**: 
  - PR = 90 表示該週票房在同年同輪次中排名前 10%
- **用途**: 反映相對市場熱度

#### audience_week_2
- **類型**: integer
- **單位**: 人次
- **說明**: 兩週前的觀影人數

#### audience_week_1
- **類型**: integer
- **單位**: 人次
- **說明**: 上週觀影人數

#### audience_week_1_PR
- **類型**: float
- **取值範圍**: 0-100
- **說明**: 上週觀影人數的百分位排名
- **計算方式**: 同 boxoffice_week_1_PR

#### screens_week_2
- **類型**: integer
- **說明**: 兩週前的院線數（放映場次數或影廳數）
- **取值範圍**: 0-500

#### screens_week_1
- **類型**: integer
- **說明**: 上週院線數

#### screens_week_1_PR
- **類型**: float
- **取值範圍**: 0-100
- **說明**: 上週院線數的百分位排名

---

### 4. 累積資訊 (6 欄位)

> **重要**: 所有累積欄位均「截至上週，不含當週」

#### boxoffice_cumsum
- **類型**: float
- **單位**: 萬元
- **說明**: 跨輪累積票房（從首輪第 1 週到上週）
- **取值範圍**: 0-100000
- **計算範圍**: 
  - 首輪電影: sum(首輪第 1 週到上週)
  - 次輪電影: sum(首輪全部 + 次輪第 1 週到上週)
- **注意**: 不包含當週票房
- **用途**: 反映電影整體累積表現

#### boxoffice_round1_cumsum
- **類型**: float
- **單位**: 萬元
- **說明**: 首輪累積票房
- **取值範圍**: 0-50000
- **計算規則**:
  - 首輪進行中: sum(首輪第 1 週到上週)
  - 首輪已結束: sum(首輪全部週次) = 固定值
- **用途**: 反映首輪表現（開片實力的另一指標）

#### boxoffice_current_round_cumsum
- **類型**: float
- **單位**: 萬元
- **說明**: 當輪累積票房（當前輪次的累積）
- **取值範圍**: 0-50000
- **計算範圍**: sum(當輪第 1 週到上週)
- **用途**: 反映當前輪次的表現

#### audience_cumsum
- **類型**: integer
- **單位**: 人次
- **說明**: 跨輪累積觀影人數
- **計算範圍**: sum(首輪 + 當輪，截至上週)

#### audience_round1_cumsum
- **類型**: integer
- **說明**: 首輪累積觀影人數

#### audience_current_round_cumsum
- **類型**: integer
- **說明**: 當輪累積觀影人數

---

### 5. 開片實力 (5 欄位)

> **重要**: 所有開片特徵固定指「首輪」，不隨當前輪次改變

#### open_week1_days
- **類型**: integer
- **說明**: 首輪第 1 週的上映天數
- **取值範圍**: 1-7
- **背景**: 
  - 不同電影上映日不同（週四、週一、週六...）
  - 首週可能只有 3-4 天或完整 7 天
- **用途**: 標準化首週票房

#### open_week1_boxoffice
- **類型**: float
- **單位**: 萬元
- **說明**: 首輪第 1 週票房（原始值）
- **注意**: 受上映天數影響

#### open_week1_boxoffice_daily_avg
- **類型**: float
- **單位**: 萬元/天
- **說明**: 首輪第 1 週日均票房
- **計算公式**: `open_week1_boxoffice / open_week1_days`
- **用途**: 消除天數差異，反映真實開片實力

#### open_week1_boxoffice_daily_avg_PR
- **類型**: float
- **取值範圍**: 0-100
- **說明**: 首週日均票房的百分位排名
- **計算方式**: 按「年份」分組計算
```python
  df.groupby('release_year')['open_week1_boxoffice_daily_avg'].rank(pct=True) * 100
```
- **為什麼按年份分組**: 不同年份票價、市場規模不同
- **解讀**: PR = 85 表示在該年度所有電影中開片實力排名前 15%

#### open_week2_boxoffice
- **類型**: float
- **單位**: 萬元
- **說明**: 首輪第 2 週票房
- **用途**: 配合首週票房計算初始衰減趨勢

---

### 6. 市場資訊 (6 欄位)

#### ticket_price_avg_current
- **類型**: float
- **單位**: 元/張
- **說明**: 發行年度的平均票價（依輪次區分）
- **取值規則**:
  - 首輪（round_idx=1）: 該年度首輪平均票價（約 350-380 元）
  - 非首輪（round_idx≥2）: 該年度次輪平均票價（約 150-180 元）
- **範例**:
```
  2023 年首輪: 350 元
  2023 年次輪: 150 元
  2024 年首輪: 360 元
  2024 年次輪: 160 元
```
- **用途**: 
  - 轉換人次與票房（票房 = 人次 × 票價）
  - 標準化不同年份、不同輪次的票房

#### release_year
- **類型**: integer
- **說明**: 首輪上映年份
- **取值範圍**: 2020-2025
- **注意**: 固定為首輪上映年份，不隨輪次改變
- **用途**: 
  - 反映市場環境（不同年份票房規模不同）
  - PR 計算的分組依據

#### release_month
- **類型**: integer
- **說明**: 首輪上映月份
- **取值範圍**: 1-12
- **用途**: 反映檔期效應（暑假、春節檔...）

#### region
- **類型**: categorical (string)
- **說明**: 發行地區
- **可能取值**: "全台", "北部", "中部", "南部"
- **編碼方式**: One-Hot 編碼
- **用途**: 反映地區差異

#### publisher
- **類型**: categorical (string)
- **說明**: 發行商名稱
- **範例**: "華納", "迪士尼", "環球", "甲上"...
- **編碼方式**: One-Hot 編碼（建議保留前 10-15 大發行商，其他合併為"其他"）
- **用途**: 反映宣傳力度和發行策略

#### is_restricted
- **類型**: boolean (0/1)
- **說明**: 是否為限制級電影
- **取值**: 
  - 0 = 否（普遍級、保護級、輔導級）
  - 1 = 是（限制級）
- **用途**: 限制級觀眾群較窄，可能影響票房

#### film_length
- **類型**: integer
- **單位**: 分鐘
- **說明**: 片長

---

### 7. 目標變數 (1 欄位)

#### target_boxoffice
- **類型**: float
- **單位**: 萬元
- **說明**: 當週票房（預測目標）
- **取值範圍**: 0-10000
- **訓練階段**: 已知值（答案）
- **預測階段**: 未知值（要預測的目標）
- **注意**: 這是唯一的預測目標，其他欄位都是特徵

---

## 資料處理規則

### 1. 資料過濾順序（重要！按順序執行）
```
步驟 1: 過濾上映日之前的週次
  → 只保留週次結束日 ≥ 正式上映日的資料
  
步驟 2: 定義輪次
  → 連續 3 週票房 = 0 視為輪次結束
  → 標記哪些 row 屬於哪一輪
  
步驟 3: 刪除不屬於任何輪次的 row
  → 連續第 3 週（含）以上票房 = 0 的 row → 刪除
  → 屬於輪次內的 row（包含票房 = 0）→ 保留
  
步驟 4: 過濾真實週次 < 3 的輪次
  → 計算每輪真實週次（含票房 = 0 的週次）
  → 真實週次 < 3 → 整輪刪除
  
步驟 5: 移除每輪末尾票房 = 0 的週次
  → 從後往前找到最後一個有票房的週次
  → 後面的 row 全部刪除
  
步驟 6: 過濾活躍週次 < 3 的輪次
  → 計算每輪活躍週次（僅計票房 > 0 的週次）
  → 活躍週次 < 3 → 整輪刪除
  
步驟 7: 重新編號輪次
  → 對剩餘輪次重新編號為 1, 2, 3...
```

### 2. 輪次定義規則
```
輪次結束條件: 連續 3 週票房 = 0
輪次成立條件: 
  - 真實週次（含輪內票房 = 0 的週次）≥ 3
  - 活躍週次（僅計票房 > 0 的週次）≥ 3
  - 輪次最後一週必須有票房

輪次容忍中斷: 輪次內允許最多連續 2 週票房 = 0

範例 1（成立的輪次）:
週次: W1  W2  W3  W4  W5  W6  W7  W8  | W9  W10 W11
票房: 有  有  有  有  有  0   0   有  | 0   0   0   (連續第3週=0，輪次結束)
輪次: ←------------ 首輪 ------------→ | (不屬於任何輪次，刪除)
真實: 1   2   3   4   5   6   7   8   |
活躍: 1   2   3   4   5   -   -   6   |
結果: ✓ 保留（真實週次 8 ≥ 3，活躍週次 6 ≥ 3）

範例 2（不成立的輪次）:
週次: W1  W2  W3  W4  | W5  W6  W7
票房: 有  有  0   0   | 0   有  有  (連續第3週=0，輪次結束)
輪次: ←-- 首輪 --→   | ←- 次輪 -→
真實: 1   2   3   4   | 1   2   3
活躍: 1   2   -   -   | 1   2   3
結果: ✗ 首輪刪除（活躍週次 2 < 3）
      ✓ 次輪保留（真實週次 3 ≥ 3，活躍週次 3 ≥ 3）
```

### 3. 週次編號規則
```
真實週次 (current_week_real_idx):
- 定義: 輪內連續編號（含票房 = 0 的週次）
- 每輪從 1 重新開始
- 不跳號，連續編號
- 範例: 
  輪次: 1  1  1  1  1  1  | 2  2  2  2
  票房: 有 有 有 0  0  有 | 有 有 有 有
  真實: 1  2  3  4  5  6  | 1  2  3  4

活躍週次 (current_week_active_idx):
- 定義: 輪內僅對票房 > 0 的週次編號
- 每輪從 1 重新開始
- 票房 = 0 的週次不編號（值為 NaN）
- 範例:
  輪次: 1  1  1  1  1  1  | 2  2  2  2
  票房: 有 有 有 0  0  有 | 有 有 有 有
  真實: 1  2  3  4  5  6  | 1  2  3  4
  活躍: 1  2  3  -  -  4  | 1  2  3  4
```

### 4. 跳週數計算規則
```
定義: 基於活躍週次計算，跳過的真實週次數量

計算公式:
gap_real_week_1tocurrent = (當前真實週次 - 前1活躍週的真實週次) - 1

範例:
活躍週次:  W1  W2  [skip W3,W4]  W5
真實週次:  1   2   3   4         5
票房:      有  有  0   0         有
活躍編號:  1   2   -   -         3

gap 計算:
- W1 → W2: gap = (2-1)-1 = 0 (沒跳)
- W2 → W5: gap = (5-2)-1 = 2 (跳了 W3, W4)
```

### 5. 累積計算規則
```
關鍵原則: 所有累積欄位「截至上週」，不包含當週

原因: 
- 訓練時: 當週是目標變數（未來要預測的值）
- 預測時: 當週票房未知，無法納入累積計算

範例（預測第 5 週時）:
✓ 正確: boxoffice_cumsum = sum(第 1,2,3,4 週)
✗ 錯誤: boxoffice_cumsum = sum(第 1,2,3,4,5 週)

累積欄位包括:
- boxoffice_cumsum: 跨輪累積票房（截至上週）
- boxoffice_round1_cumsum: 首輪累積票房（截至上週）
- boxoffice_current_round_cumsum: 當輪累積票房（截至上週）
- audience_cumsum: 跨輪累積觀影人次（截至上週）
- audience_round1_cumsum: 首輪累積觀影人次（截至上週）
- audience_current_round_cumsum: 當輪累積觀影人次（截至上週）
```

### 6. Lag Features 規則
```
定義: 前期週次的資料，用於捕捉趨勢

基於活躍週次計算:
- boxoffice_week_1: 前 1 個活躍週的票房
- boxoffice_week_2: 前 2 個活躍週的票房
- audience_week_1: 前 1 個活躍週的觀影人次
- audience_week_2: 前 2 個活躍週的觀影人次
- screens_week_1: 前 1 個活躍週的院線數
- screens_week_2: 前 2 個活躍週的院線數

範例:
活躍週次:  W1  W2  [skip W3,W4]  W5  W6
票房:      50  70  0   0         60  40
活躍編號:  1   2   -   -         3   4

Lag Features:
- W5 (活躍週 3): week_1 = 70, week_2 = 50
- W6 (活躍週 4): week_1 = 60, week_2 = 70
```

### 7. PR 計算規則
```
定義: Percentile Rank（百分位數排名）

分組原則:
- boxoffice_week_1_PR: 按 [年份 × 輪次] 分組
- audience_week_1_PR: 按 [年份 × 輪次] 分組
- screens_week_1_PR: 按 [年份 × 輪次] 分組
- open_week1_boxoffice_daily_avg_PR: 按 [年份] 分組

原因: 
- 不同年份市場規模不同（票價、觀影習慣）
- 不同輪次票房範圍差異大（首輪 vs 次輪）
- 首週日均票房只需按年份分組（不分輪次）
- 分組後 PR 才有可比性
```

### 8. 開片實力規則
```
定義: 固定指首輪數據，不隨輪次改變

欄位:
- open_week1_days: 首輪第 1 週上映天數
- open_week1_boxoffice: 首輪第 1 週票房
- open_week1_boxoffice_daily_avg: 首輪第 1 週日均票房
- open_week2_boxoffice: 首輪第 2 週票房

特性:
- 每部電影的所有 row 都是相同值
- 反映電影的市場接受度
- 用於預測後續輪次表現
```

---

## 資料質量檢查清單

### 必要檢查項目

- [ ] 無缺失值（除了刻意刪除的 row）
- [ ] 無負數票房/人數
- [ ] week_-2 ≤ week_-1 ≤ target（時間順序正確）
- [ ] boxoffice_current_round_cumsum ≤ boxoffice_cumsum
- [ ] boxoffice_round1_cumsum ≤ boxoffice_cumsum
- [ ] PR 值在 0-100 範圍內
- [ ] 每部電影的首輪開片特徵（open_*）一致
- [ ] rounds_cumsum ≥ round_idx

---

## 附錄

### A. 資料範例
```csv
movie_id,round_idx,current_week_real_idx,current_week_active_idx,boxoffice_week_1,target_boxoffice
M001,1,3,3,3500,2500
M001,1,4,4,2500,1800
M002,2,3,3,600,450
```

### B. 常見問題

**Q: 為什麼累積不包含當週？**
A: 預測時當週票房未知，無法計算包含當週的累積。訓練和預測必須使用相同的資訊。

**Q: 為什麼開片特徵不隨輪次改變？**
A: 開片實力反映電影的初始吸引力，應該用首輪表現。次輪的「首週」受首輪影響，不是真正的開片實力。

**Q: 真實週次 vs 活躍週次的差異？**
A: 真實週次是輪內連續編號，活躍週次是去除票房=0後重編。兩者都有價值，分別反映時間流逝和實際上映週數。

---

## 更新日誌

- **v1.0** (2024-01-XX): 初始版本，定義 33 個特徵 + 1 個目標變數