# 電影票房預測 - 資料處理規則

> **版本**: 1.0  
> **更新日期**: 2024-01-XX  
> **用途**: 定義資料前處理、輪次判定、週次編號、PR 與 Lag 特徵生成的標準流程，確保訓練與預測一致性。

**相關文件**：
- [資料處理規則](data_processing_rules.md) - 輪次定義、週次編號等規則
- [欄位定義](data_dictionary.md) - 所有特徵欄位的詳細說明(人類可讀)
- [特徵配置](feature_config.yaml) - 所有特徵欄位的詳細說明(機器可讀)
- [Pipeline 流程](pipeline.md) - 完整的資料處理流程

---

## 重要規則

### 1. 資料過濾順序（重要！按順序執行）
```
步驟 1: 過濾上映日之前的週次
  → 只保留週次結束日 ≥ 正式上映日的資料
  
步驟 2: 定義輪次
  → 連續 3 週票房 = 0 視為輪次結束
  → 標記哪些 row 屬於哪一輪
  
步驟 3: 刪除不屬於任何輪次的 row
  → 連續第 3 週（含）以上票房 = 0 的 row → 刪除
  → 屬於輪次內的 row（包含票房 = 0）→ 保留
  
步驟 4: 過濾真實週次 < 3 的輪次
  → 計算每輪真實週次（含票房 = 0 的週次）
  → 真實週次 < 3 → 整輪刪除
  
步驟 5: 移除每輪末尾票房 = 0 的週次
  → 從後往前找到最後一個有票房的週次
  → 後面的 row 全部刪除
  
步驟 6: 過濾活躍週次 < 3 的輪次
  → 計算每輪活躍週次（僅計票房 > 0 的週次）
  → 活躍週次 < 3 → 整輪刪除
  
步驟 7: 重新編號輪次
  → 對剩餘輪次重新編號為 1, 2, 3...
```

### 2. 輪次定義規則
```
輪次結束條件: 連續 3 週票房 = 0
輪次成立條件: 
  - 真實週次（含輪內票房 = 0 的週次）≥ 3
  - 活躍週次（僅計票房 > 0 的週次）≥ 3
  - 輪次最後一週必須有票房

輪次容忍中斷: 輪次內允許最多連續 2 週票房 = 0

範例 1（成立的輪次）:
週次: W1  W2  W3  W4  W5  W6  W7  W8  | W9  W10 W11
票房: 有  有  有  有  有  0   0   有  | 0   0   0   (連續第3週=0，輪次結束)
輪次: ←------------ 首輪 ------------→ | (不屬於任何輪次，刪除)
真實: 1   2   3   4   5   6   7   8   |
活躍: 1   2   3   4   5   -   -   6   |
結果: ✓ 保留（真實週次 8 ≥ 3，活躍週次 6 ≥ 3）

範例 2（不成立的輪次）:
週次: W1  W2  W3  W4  | W5  W6  W7
票房: 有  有  0   0   | 0   有  有  (連續第3週=0，輪次結束)
輪次: ←-- 首輪 --→   | ←- 次輪 -→
真實: 1   2   3   4   | 1   2   3
活躍: 1   2   -   -   | 1   2   3
結果: ✗ 首輪刪除（活躍週次 2 < 3）
      ✓ 次輪保留（真實週次 3 ≥ 3，活躍週次 3 ≥ 3）
```

### 3. 週次編號規則
```
真實週次 (current_week_real_idx):
- 定義: 輪內連續編號（含票房 = 0 的週次）
- 每輪從 1 重新開始
- 不跳號，連續編號
- 範例: 
  輪次: 1  1  1  1  1  1  | 2  2  2  2
  票房: 有 有 有 0  0  有 | 有 有 有 有
  真實: 1  2  3  4  5  6  | 1  2  3  4

活躍週次 (current_week_active_idx):
- 定義: 輪內僅對票房 > 0 的週次編號
- 每輪從 1 重新開始
- 票房 = 0 的週次不編號（值為 NaN）
- 範例:
  輪次: 1  1  1  1  1  1  | 2  2  2  2
  票房: 有 有 有 0  0  有 | 有 有 有 有
  真實: 1  2  3  4  5  6  | 1  2  3  4
  活躍: 1  2  3  -  -  4  | 1  2  3  4
```

### 4. 跳週數計算規則
```
定義: 基於活躍週次計算，跳過的真實週次數量

計算公式:
gap_real_week_1tocurrent = (當前真實週次 - 前1活躍週的真實週次) - 1

範例:
活躍週次:  W1  W2  [skip W3,W4]  W5
真實週次:  1   2   3   4         5
票房:      有  有  0   0         有
活躍編號:  1   2   -   -         3

gap 計算:
- W1 → W2: gap = (2-1)-1 = 0 (沒跳)
- W2 → W5: gap = (5-2)-1 = 2 (跳了 W3, W4)
```

### 5. 累積計算規則
```
關鍵原則: 所有累積欄位「截至上週」，不包含當週

原因: 
- 訓練時: 當週是目標變數（未來要預測的值）
- 預測時: 當週票房未知，無法納入累積計算

範例（預測第 5 週時）:
✓ 正確: boxoffice_cumsum = sum(第 1,2,3,4 週)
✗ 錯誤: boxoffice_cumsum = sum(第 1,2,3,4,5 週)

累積欄位包括:
- boxoffice_cumsum: 跨輪累積票房（截至上週）
- boxoffice_round1_cumsum: 首輪累積票房（截至上週）
- boxoffice_current_round_cumsum: 當輪累積票房（截至上週）
- audience_cumsum: 跨輪累積觀影人次（截至上週）
- audience_round1_cumsum: 首輪累積觀影人次（截至上週）
- audience_current_round_cumsum: 當輪累積觀影人次（截至上週）
```

### 6. Lag Features 規則
```
定義: 前期週次的資料，用於捕捉趨勢

基於活躍週次計算:
- boxoffice_week_1: 前 1 個活躍週的票房
- boxoffice_week_2: 前 2 個活躍週的票房
- audience_week_1: 前 1 個活躍週的觀影人次
- audience_week_2: 前 2 個活躍週的觀影人次
- screens_week_1: 前 1 個活躍週的院線數
- screens_week_2: 前 2 個活躍週的院線數

範例:
活躍週次:  W1  W2  [skip W3,W4]  W5  W6
票房:      50  70  0   0         60  40
活躍編號:  1   2   -   -         3   4

Lag Features:
- W5 (活躍週 3): week_1 = 70, week_2 = 50
- W6 (活躍週 4): week_1 = 60, week_2 = 70
```

### 7. PR 計算規則
```
定義: Percentile Rank（百分位數排名）

分組原則:
- boxoffice_week_1_PR: 按 [年份 × 輪次] 分組
- audience_week_1_PR: 按 [年份 × 輪次] 分組
- screens_week_1_PR: 按 [年份 × 輪次] 分組
- open_week1_boxoffice_daily_avg_PR: 按 [年份] 分組

原因: 
- 不同年份市場規模不同（票價、觀影習慣）
- 不同輪次票房範圍差異大（首輪 vs 次輪）
- 首週日均票房只需按年份分組（不分輪次）
- 分組後 PR 才有可比性
```

### 8. 開片實力規則
```
定義: 固定指首輪數據，不隨輪次改變

欄位:
- open_week1_days: 首輪第 1 週上映天數
- open_week1_boxoffice: 首輪第 1 週票房
- open_week1_boxoffice_daily_avg: 首輪第 1 週日均票房
- open_week2_boxoffice: 首輪第 2 週票房

特性:
- 每部電影的所有 row 都是相同值
- 反映電影的市場接受度
- 用於預測後續輪次表現
```

---

## 資料質量檢查清單

### 必要檢查項目

- [ ] 無缺失值（除了刻意刪除的 row）
- [ ] 無負數票房/人數
- [ ] week_-2 ≤ week_-1 ≤ target（時間順序正確）
- [ ] boxoffice_current_round_cumsum ≤ boxoffice_cumsum
- [ ] boxoffice_round1_cumsum ≤ boxoffice_cumsum
- [ ] PR 值在 0-100 範圍內
- [ ] 每部電影的首輪開片特徵（open_*）一致
- [ ] rounds_cumsum ≥ round_idx