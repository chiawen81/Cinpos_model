# é›»å½±ç¥¨æˆ¿é æ¸¬å°ˆæ¡ˆ - å·¥ä½œæ—¥èªŒ

## ğŸ“… æœ€å¾Œæ›´æ–°ï¼š2025-11-12

---

## ğŸ¯ æœ¬æ¬¡æ›´æ–°å…§å®¹

### 1. å»ºç«‹ç‰¹å¾µå·¥ç¨‹è‡ªå‹•åŒ– Pipeline ç³»çµ±

**æ–°å¢æª”æ¡ˆ**ï¼š`scripts/run_feature_pipeline.py`

**åŠŸèƒ½èªªæ˜**ï¼š
- ä¸€éµåŸ·è¡Œå®Œæ•´çš„ç‰¹å¾µå·¥ç¨‹æµç¨‹
- è‡ªå‹•ç”Ÿæˆ 4 å€‹æª”æ¡ˆï¼š
  1. åº•ç¨¿ï¼ˆåŸºç¤æ™‚åºè³‡æ–™ï¼‰
  2. åªå«ç´¯è¨ˆç‰¹å¾µç‰ˆæœ¬
  3. åªå«å¸‚å ´ç‰¹å¾µç‰ˆæœ¬
  4. å®Œæ•´ç‰ˆæœ¬ï¼ˆç´¯è¨ˆ+å¸‚å ´ç‰¹å¾µï¼‰

**ä½¿ç”¨æ–¹å¼**ï¼š
```bash
# åŸ·è¡Œå®Œæ•´ pipeline
uv run scripts/run_feature_pipeline.py

# æ¸¬è©¦æ¨¡å¼ï¼ˆdry-runï¼‰
uv run scripts/run_feature_pipeline.py --dry-run
```

**Pipeline æµç¨‹**ï¼š
```
Step 1: flatten_timeseries.py
  â””â”€ è¼¸å‡º: boxoffice_timeseries_<æ—¥æœŸ>.csv
  â””â”€ å ±å‘Š: boxoffice_timeseries_<æ—¥æœŸ>_report.txt

Step 2: add_cumsum_features.py (ä½¿ç”¨ Step 1 è¼¸å‡º)
  â””â”€ è¼¸å‡º: features_cumsum_<æ™‚é–“æˆ³>.csv

Step 3: add_market_features.py (ä½¿ç”¨ Step 1 è¼¸å‡º)
  â””â”€ è¼¸å‡º: features_market_<æ™‚é–“æˆ³>.csv

Step 4: add_market_features.py (ä½¿ç”¨ Step 2 è¼¸å‡º)
  â””â”€ è¼¸å‡º: features_full_<æ™‚é–“æˆ³>.csv (æ”¾åœ¨ phase2_features/full/)
```

### 2. æ–°å¢è³‡æ–™å“è³ªå ±å‘ŠåŠŸèƒ½

**ä¿®æ”¹æª”æ¡ˆ**ï¼š`src/ML_boxoffice/phase1_flatten/flatten_timeseries.py`

**æ–°å¢å‡½æ•¸**ï¼š`generate_data_quality_report()`

**å ±å‘Šå…§å®¹**ï¼š
1. **å‰ä¸‰å‘¨ç¥¨æˆ¿ç‚º0çš„è³‡æ–™åˆ†æ**
   - çµ±è¨ˆç­†æ•¸
   - æ¶‰åŠé›»å½±æ•¸é‡
   - åˆ—å‡ºæ‰€æœ‰æ¶‰åŠçš„é›»å½±ç·¨è™Ÿ

2. **é›¢ç¾¤å€¼åˆ†æï¼ˆIQR æ–¹æ³•ï¼‰**
   - åˆ†ææ‰€æœ‰æ•¸å€¼å‹ç‰¹å¾µæ¬„ä½
   - è¨ˆç®— Q1, Q3, IQR
   - æ¨™è¨˜é›¢ç¾¤å€¼ç¯„åœï¼ˆ< Q1-1.5*IQR æˆ– > Q3+1.5*IQRï¼‰
   - çµ±è¨ˆé›¢ç¾¤å€¼æ•¸é‡å’Œæ¯”ä¾‹
   - æä¾›é›¢ç¾¤å€¼çš„æœ€å°å€¼ã€æœ€å¤§å€¼ã€å¹³å‡å€¼

3. **ç¼ºå¤±å€¼åˆ†æ**
   - çµ±è¨ˆæ¯å€‹æ¬„ä½çš„ç¼ºå¤±å€¼æ•¸é‡
   - è¨ˆç®—ç¼ºå¤±å€¼æ¯”ä¾‹
   - æŒ‰ç¼ºå¤±å€¼æ¯”ä¾‹æ’åºé¡¯ç¤º

**è¼¸å‡ºä½ç½®**ï¼š
- `data/ML_boxoffice/phase1_flattened/boxoffice_timeseries_<æ—¥æœŸ>_report.txt`

### 3. å¢å¼· add_market_features.py çš„å½ˆæ€§

**ä¿®æ”¹å…§å®¹**ï¼š
- æ–°å¢ `--output` åƒæ•¸ï¼Œæ”¯æ´è‡ªè¨‚è¼¸å‡ºè·¯å¾‘
- ä¿®æ”¹ `main()` å‡½æ•¸æ¥å— `output_file` åƒæ•¸
- ä½¿ç”¨ `datetime` è€Œé `date` ç”Ÿæˆæ™‚é–“æˆ³ï¼ˆåŒ…å«æ™‚åˆ†ï¼‰

**ä½¿ç”¨ç¯„ä¾‹**ï¼š
```bash
# è‡ªå‹•è¼¸å‡ºåˆ°é è¨­ä½ç½®
uv run src/ML_boxoffice/phase2_features/add_market_features.py

# æŒ‡å®šè¼¸å‡ºä½ç½®
uv run src/ML_boxoffice/phase2_features/add_market_features.py \
  --input data/ML_boxoffice/phase1_flattened/boxoffice_timeseries_2025-11-12.csv \
  --output data/ML_boxoffice/phase2_features/full/features_full_2025-11-12.csv
```

---

## ğŸ“‚ æ–°å¢çš„æª”æ¡ˆçµæ§‹

```
scripts/
â””â”€â”€ run_feature_pipeline.py          â† æ–°å¢ï¼šè‡ªå‹•åŒ– pipeline

data/ML_boxoffice/
â”œâ”€â”€ phase1_flattened/
â”‚   â”œâ”€â”€ boxoffice_timeseries_<æ—¥æœŸ>.csv
â”‚   â””â”€â”€ boxoffice_timeseries_<æ—¥æœŸ>_report.txt  â† æ–°å¢ï¼šè³‡æ–™å“è³ªå ±å‘Š
â”‚
â”œâ”€â”€ phase2_features/
â”‚   â”œâ”€â”€ with_cumsum/
â”‚   â”‚   â””â”€â”€ features_cumsum_<æ™‚é–“æˆ³>.csv
â”‚   â”œâ”€â”€ with_market/
â”‚   â”‚   â””â”€â”€ features_market_<æ™‚é–“æˆ³>.csv
â”‚   â””â”€â”€ full/
â”‚       â””â”€â”€ features_full_<æ™‚é–“æˆ³>.csv          â† æ–°å¢ï¼šå®Œæ•´ç‰¹å¾µæª”æ¡ˆ
```

---

## âš ï¸ ä¸‹æ¬¡å·¥ä½œæé†’

### ğŸ§ª æ¸¬è©¦å¾…è¾¦äº‹é …

1. **æ¸¬è©¦ Pipeline è…³æœ¬**
   ```bash
   # å…ˆåŸ·è¡Œ dry-run æ¸¬è©¦
   uv run scripts/run_feature_pipeline.py --dry-run

   # ç¢ºèªç„¡èª¤å¾ŒåŸ·è¡Œå¯¦éš›é‹ç®—
   uv run scripts/run_feature_pipeline.py
   ```

   **æª¢æŸ¥é …ç›®**ï¼š
   - [ ] 4 å€‹æª”æ¡ˆæ˜¯å¦éƒ½æ­£ç¢ºç”Ÿæˆ
   - [ ] è³‡æ–™å“è³ªå ±å‘Šå…§å®¹æ˜¯å¦å®Œæ•´
   - [ ] æª”æ¡ˆè·¯å¾‘æ˜¯å¦ç¬¦åˆé æœŸ
   - [ ] ç´¯è¨ˆç‰¹å¾µè¨ˆç®—æ˜¯å¦æ­£ç¢º
   - [ ] å¸‚å ´ç‰¹å¾µåˆä½µæ˜¯å¦æ­£ç¢º

2. **æª¢æŸ¥è³‡æ–™å“è³ªå ±å‘Š**
   - [ ] å‰ä¸‰å‘¨ç¥¨æˆ¿ç‚º0çš„é›»å½±æ¸…å–®æ˜¯å¦åˆç†
   - [ ] é›¢ç¾¤å€¼æ¯”ä¾‹æ˜¯å¦éé«˜ï¼ˆéœ€è¦èª¿æŸ¥åŸå› ï¼‰
   - [ ] ç¼ºå¤±å€¼æ¯”ä¾‹æ˜¯å¦å¯æ¥å—

### ğŸ—‚ï¸ è³‡æ–™æ¸…ç†æµç¨‹æé†’

**ç•¶çˆ¬å®Œç‰¹å®šæ™‚é–“ç¯„åœçš„è³‡æ–™å¾Œ**ï¼š

1. **ä½¿ç”¨æ­¤ Pipeline ç³»çµ±é€²è¡Œè³‡æ–™è™•ç†**
   ```bash
   # ç¢ºä¿å·²ç¶“çˆ¬å®Œç›®æ¨™æ™‚é–“ç¯„åœçš„è³‡æ–™
   # åŸ·è¡Œ pipeline ç”Ÿæˆç‰¹å¾µæª”æ¡ˆ
   uv run scripts/run_feature_pipeline.py
   ```

2. **æª¢æŸ¥è³‡æ–™å“è³ªå ±å‘Š**
   - æŸ¥çœ‹å ±å‘Šä¸­æ¨™è¨˜çš„ç•°å¸¸é›»å½±
   - æ±ºå®šæ˜¯å¦éœ€è¦æ’é™¤æŸäº›é›»å½±
   - æ›´æ–° `config/exclude_movies.csv` æ’é™¤æ¸…å–®

3. **è™•ç†ç‰¹å®šæ™‚é–“æ®µçš„è³‡æ–™**
   - å¦‚æœéœ€è¦åªè™•ç†ç‰¹å®šæ™‚é–“ç¯„åœï¼Œå¯ä»¥ï¼š
     - é¸é … Aï¼šåœ¨ `flatten_timeseries.py` ä¸­åŠ å…¥æ—¥æœŸç¯„åœåƒæ•¸
     - é¸é … Bï¼šè™•ç†å¾Œå†éæ¿¾ç‰¹å®šæ™‚é–“æ®µçš„è³‡æ–™

4. **å»ºè­°çš„å¾ŒçºŒæ­¥é©Ÿ**
   ```bash
   # Step 1: åŸ·è¡Œ pipeline
   uv run scripts/run_feature_pipeline.py

   # Step 2: æª¢æŸ¥å ±å‘Š
   # é–±è®€ data/ML_boxoffice/phase1_flattened/boxoffice_timeseries_*_report.txt

   # Step 3: å¦‚éœ€æ’é™¤å•é¡Œé›»å½±ï¼Œæ›´æ–°æ’é™¤æ¸…å–®
   # ç·¨è¼¯ config/exclude_movies.csv

   # Step 4: ä½¿ç”¨å®Œæ•´ç‰¹å¾µæª”æ¡ˆé€²è¡Œå»ºæ¨¡
   # ä½¿ç”¨ data/ML_boxoffice/phase2_features/full/features_full_*.csv
   ```

### ğŸ“ æœªä¾†æ”¹å–„å»ºè­°

1. **æ—¥æœŸç¯„åœéæ¿¾åŠŸèƒ½**
   - åœ¨ Pipeline è…³æœ¬ä¸­åŠ å…¥ `--start-date` å’Œ `--end-date` åƒæ•¸
   - åªè™•ç†æŒ‡å®šæ—¥æœŸç¯„åœå…§çš„ç¥¨æˆ¿è³‡æ–™

2. **å ±å‘Šå¼·åŒ–**
   - åŠ å…¥æ™‚é–“åºåˆ—å®Œæ•´æ€§æª¢æŸ¥
   - æ¨™è¨˜é€±æ¬¡è³‡æ–™ä¸é€£çºŒçš„é›»å½±
   - è¦–è¦ºåŒ–é›¢ç¾¤å€¼åˆ†ä½ˆåœ–

3. **è‡ªå‹•åŒ–ç¨‹åº¦æå‡**
   - æ•´åˆè³‡æ–™çˆ¬å– â†’ æ¸…ç† â†’ ç‰¹å¾µå·¥ç¨‹ â†’ å»ºæ¨¡çš„å®Œæ•´æµç¨‹
   - åŠ å…¥éŒ¯èª¤è™•ç†å’Œæ–·é»çºŒå‚³æ©Ÿåˆ¶

---

## ğŸ”— ç›¸é—œæª”æ¡ˆ

### ä¸»è¦è…³æœ¬
- `scripts/run_feature_pipeline.py` - Pipeline åŸ·è¡Œå™¨
- `src/ML_boxoffice/phase1_flatten/flatten_timeseries.py` - æ™‚åºæ‹‰å¹³ + å ±å‘Šç”Ÿæˆ
- `src/ML_boxoffice/phase2_features/add_cumsum_features.py` - ç´¯è¨ˆç‰¹å¾µ
- `src/ML_boxoffice/phase2_features/add_market_features.py` - å¸‚å ´ç‰¹å¾µ

### æ–‡æª”
- `docs/ML_boxoffice/pipeline.md` - Pipeline æµç¨‹èªªæ˜
- `docs/ML_boxoffice/data_dictionary.md` - æ¬„ä½å®šç¾©
- `CLAUDE.md` - å°ˆæ¡ˆä½¿ç”¨èªªæ˜

### é…ç½®
- `config/exclude_movies.csv` - é›»å½±æ’é™¤æ¸…å–®

---

## ğŸ’¡ è¨­è¨ˆç†å¿µ

### Pipeline ç³»çµ±çš„å„ªé»
1. **æ¨¡çµ„åŒ–**ï¼šæ¯å€‹æ­¥é©Ÿéƒ½æ˜¯ç¨ç«‹è…³æœ¬ï¼Œæ˜“æ–¼ç¶­è­·
2. **å¯è¿½æº¯**ï¼šä¿ç•™ä¸­é–“æª”æ¡ˆï¼Œæ–¹ä¾¿æª¢æŸ¥æ¯ä¸€æ­¥çš„çµæœ
3. **å½ˆæ€§**ï¼šå¯ä»¥åªåŸ·è¡Œç‰¹å®šæ­¥é©Ÿï¼Œæˆ–ä½¿ç”¨ä¸åŒçµ„åˆ

### è³‡æ–™å“è³ªå ±å‘Šçš„åƒ¹å€¼
1. **åŠæ—©ç™¼ç¾å•é¡Œ**ï¼šåœ¨ç‰¹å¾µå·¥ç¨‹éšæ®µå°±ç™¼ç¾è³‡æ–™ç•°å¸¸
2. **è¼”åŠ©æ±ºç­–**ï¼šæä¾›å®¢è§€æ•¸æ“šï¼Œå”åŠ©åˆ¤æ–·æ˜¯å¦æ’é™¤æŸäº›é›»å½±
3. **å¯è¿½æº¯æ€§**ï¼šæ¯æ¬¡åŸ·è¡Œéƒ½æœ‰å ±å‘Šï¼Œå¯ä»¥æ¯”å°ä¸åŒç‰ˆæœ¬çš„å·®ç•°

---

## ğŸ“š è£œå……èªªæ˜

### ç‚ºä»€éº¼è¦ç”Ÿæˆ 4 å€‹æª”æ¡ˆï¼Ÿ

1. **åº•ç¨¿ï¼ˆæª”æ¡ˆ1ï¼‰**ï¼š
   - æœ€åŸå§‹çš„æ™‚åºè³‡æ–™
   - å¯ä½œç‚ºå…¶ä»–åˆ†æçš„åŸºç¤
   - åŒ…å«å®Œæ•´çš„å ±å‘Šä¾›æª¢æŸ¥

2. **åªå«ç´¯è¨ˆç‰¹å¾µï¼ˆæª”æ¡ˆ2ï¼‰**ï¼š
   - ç”¨æ–¼ç ”ç©¶ç´¯è¨ˆç‰¹å¾µçš„æ•ˆæœ
   - å¯å–®ç¨è©•ä¼°ç´¯è¨ˆå‹ç‰¹å¾µçš„è²¢ç»

3. **åªå«å¸‚å ´ç‰¹å¾µï¼ˆæª”æ¡ˆ3ï¼‰**ï¼š
   - ç”¨æ–¼ç ”ç©¶å¸‚å ´ç’°å¢ƒç‰¹å¾µçš„æ•ˆæœ
   - å¯å–®ç¨è©•ä¼°å¸‚å ´ç‰¹å¾µçš„è²¢ç»

4. **å®Œæ•´ç‰ˆæœ¬ï¼ˆæª”æ¡ˆ4ï¼‰**ï¼š
   - åŒ…å«æ‰€æœ‰ç‰¹å¾µ
   - ç”¨æ–¼æœ€çµ‚å»ºæ¨¡
   - æ”¾åœ¨ `full/` ç›®éŒ„ä¾¿æ–¼è­˜åˆ¥

---

**å‚™è¨»**ï¼šæ­¤å·¥ä½œæ—¥èªŒè¨˜éŒ„ 2025-11-12 çš„ä¸»è¦å·¥ä½œã€‚ä¸‹æ¬¡å·¥ä½œè«‹å‹™å¿…å…ˆæ¸¬è©¦æ­¤ Pipeline ç³»çµ±ã€‚
