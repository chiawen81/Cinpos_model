# å·¥ä½œæ—¥èªŒ - å¤–éƒ¨ API èª¿ç”¨å•é¡Œé™¤éŒ¯

æœ€å¾Œæ›´æ–°ï¼š2025-11-16

---

## ğŸ”´ å•é¡Œæè¿°

### ç¾æ³
åœ¨ Web ç«¯é€éå¾Œç«¯ä»£ç†å‘¼å«å¤–éƒ¨ API (`https://boxofficetw.tfai.org.tw/film/*`) æ™‚é‡åˆ° **403 Forbidden** éŒ¯èª¤ã€‚

**å½±éŸ¿ç¯„åœ**ï¼š
- `/api/search-movie` - æœå°‹é›»å½±åŠŸèƒ½å¤±æ•—
- `/api/movie-detail/{id}` - å–å¾—é›»å½±è©³ç´°è³‡æ–™å¤±æ•—

**ç’°å¢ƒå·®ç•°**ï¼š
- âœ… **æœ¬åœ°çˆ¬èŸ²ç›´æ¥å‘¼å«** - æˆåŠŸ
- âš ï¸ **æœ¬åœ° Web ç«¯é€éä»£ç†** - å¸¸å ±éŒ¯ï¼ˆå¶çˆ¾æˆåŠŸï¼‰
- âŒ **Render.com éƒ¨ç½²å¾Œ** - å®Œå…¨å¤±æ•—

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
403 Client Error: Forbidden for url: https://boxofficetw.tfai.org.tw/film/sf?keyword=%E5%89%B5
```

---

## ğŸ” å¯èƒ½çš„åŸå› åˆ†æ

### 1. Cloudflare åçˆ¬èŸ²é˜²è­·æ©Ÿåˆ¶
å¤–éƒ¨ API æœ‰ **Cloudflare é˜²è­·**ï¼Œå¯èƒ½çš„æª¢æ¸¬é»ï¼š
- âŒ **ç¼ºå°‘é—œéµ Headers** - ç€è¦½å™¨ç‰¹å¾µ headers ä¸å®Œæ•´
- âŒ **ç¼ºå°‘ Cookies** - æœªå…ˆè¨ªå•ç¶²ç«™å–å¾— session cookies
- âŒ **ç¼ºå°‘è‡ªå®šç¾©é©—è­‰ Header** - `x-kl-saas-ajax-request: Ajax_Request`
- âŒ **IP ä¿¡è­½å•é¡Œ** - Render.com çš„ IP å¯èƒ½è¢«åˆ—å…¥é»‘åå–®
- âŒ **TLS æŒ‡ç´‹è­˜åˆ¥** - Cloudflare å¯èƒ½æª¢æ¸¬åˆ°éçœŸå¯¦ç€è¦½å™¨

### 2. è«‹æ±‚ç‰¹å¾µä¸è¶³
èˆ‡çœŸå¯¦ç€è¦½å™¨è«‹æ±‚çš„å·®ç•°ï¼š
- User-Agent ç‰ˆæœ¬éèˆŠï¼ˆChrome 120 vs 142ï¼‰
- ç¼ºå°‘ `sec-fetch-*` ç³»åˆ— headers
- ç¼ºå°‘ `sec-ch-ua-*` å®¢æˆ¶ç«¯æç¤º headers
- URL ç¼ºå°‘æ™‚é–“æˆ³åƒæ•¸ï¼ˆ`_=timestamp`ï¼‰

### 3. ç’°å¢ƒå·®ç•°
- **æœ¬åœ°çˆ¬èŸ²** - å¯èƒ½ä½¿ç”¨äº†ä¸åŒçš„è«‹æ±‚æ–¹å¼æˆ–æœ‰æ•ˆçš„ cookies
- **Render.com** - IP åœ°å€ã€ç¶²è·¯ç’°å¢ƒã€TLS æ¡æ‰‹ç‰¹å¾µéƒ½èˆ‡æœ¬åœ°ä¸åŒ

---

## ğŸ”§ å·²å˜—è©¦çš„è§£æ±ºæ–¹æ³•

### ç¬¬ä¸€æ¬¡å˜—è©¦ï¼šåŸºæœ¬ Headers + é‡è©¦æ©Ÿåˆ¶
**æ™‚é–“**ï¼šåˆæœŸç‰ˆæœ¬

**åšæ³•**ï¼š
```python
# ä½¿ç”¨ cloudscraper
scraper = cloudscraper.create_scraper()

# åŸºæœ¬ headers
headers = {
    'User-Agent': '...',
    'Referer': 'https://boxofficetw.tfai.org.tw/',
    'Origin': 'https://boxofficetw.tfai.org.tw',
    'Accept': 'application/json, text/plain, */*',
}

# é‡è©¦æ©Ÿåˆ¶ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰
for attempt in range(3):
    response = scraper.get(url, params=params, headers=headers)
```

**çµæœ**ï¼šâŒ å¤±æ•—ï¼ˆä»ç„¶ 403ï¼‰

---

### ç¬¬äºŒæ¬¡å˜—è©¦ï¼šç§»é™¤é‡è©¦ï¼Œç°¡åŒ–ç¨‹å¼ç¢¼
**æ™‚é–“**ï¼šç”¨æˆ¶è¦æ±‚

**åšæ³•**ï¼š
- ç§»é™¤é‡è©¦æ©Ÿåˆ¶
- ç§»é™¤ `from network_utils import get_default_headers` æœªä½¿ç”¨çš„åŒ¯å…¥
- ç›´æ¥åœ¨ç¨‹å¼ç¢¼ä¸­å®šç¾© headers

**çµæœ**ï¼šâŒ å¤±æ•—ï¼ˆå•é¡Œæœªè§£æ±ºï¼‰

---

### ç¬¬ä¸‰æ¬¡å˜—è©¦ï¼šå®Œæ•´æ¨¡æ“¬ç€è¦½å™¨è«‹æ±‚ï¼ˆç•¶å‰ç‰ˆæœ¬ï¼‰
**æ™‚é–“**ï¼šåˆ†æç€è¦½å™¨ DevTools å¾Œ

**åšæ³•**ï¼š
```python
# 1. å¼·åŒ– cloudscraper é…ç½®
scraper = cloudscraper.create_scraper(
    browser={
        'browser': 'chrome',
        'platform': 'windows',
        'desktop': True
    }
)

# 2. å…ˆè¨ªå•é¦–é å–å¾— cookies
scraper.get('https://boxofficetw.tfai.org.tw/', timeout=10)

# 3. æ·»åŠ æ™‚é–“æˆ³åƒæ•¸
timestamp = int(time.time() * 1000)
params = {'keyword': keyword, '_': timestamp}

# 4. å®Œæ•´çš„ç€è¦½å™¨ headers
headers = {
    'User-Agent': 'Mozilla/5.0 ... Chrome/142.0.0.0 ...',  # æ›´æ–°ç‰ˆæœ¬
    'Accept': '*/*',
    'Accept-Language': 'zh-TW,zh;q=0.9,en-US;q=0.8,en;q=0.7',
    'Accept-Encoding': 'gzip, deflate, br, zstd',
    'Referer': 'https://boxofficetw.tfai.org.tw/search/32462',
    'Content-Type': 'application/json',
    'sec-ch-ua': '"Chromium";v="142", "Google Chrome";v="142"...',
    'sec-ch-ua-mobile': '?0',
    'sec-ch-ua-platform': '"Windows"',
    'sec-fetch-dest': 'empty',
    'sec-fetch-mode': 'cors',
    'sec-fetch-site': 'same-origin',
    'x-kl-saas-ajax-request': 'Ajax_Request',  # é—œéµè‡ªå®šç¾© header
    'priority': 'u=1, i',
}
```

**é—œéµæ”¹é€²**ï¼š
1. âœ… æ·»åŠ  `x-kl-saas-ajax-request: Ajax_Request` è‡ªå®šç¾©é©—è­‰ header
2. âœ… å…ˆè¨ªå•é¦–é å–å¾— Google Analytics cookies (`_ga`, `_ga_YJ385WSQ1N`)
3. âœ… æ·»åŠ æ™‚é–“æˆ³åƒæ•¸é˜²æ­¢å¿«å–
4. âœ… æ·»åŠ å®Œæ•´çš„ `sec-fetch-*` å’Œ `sec-ch-ua-*` headers
5. âœ… æ›´æ–° User-Agent ç‰ˆæœ¬è‡³ Chrome 142
6. âœ… æ¨¡æ“¬ä¾†è‡ªåŒç¶²ç«™çš„ Referer

**çµæœ**ï¼šâ³ å¾…æ¸¬è©¦

---

## ğŸ§ª ç›®å‰å°‡é€²è¡Œçš„æ¸¬è©¦ç’°ç¯€

### æ¸¬è©¦æ­¥é©Ÿ
1. **é‡å•Ÿæœå‹™**
   ```bash
   cd src/web/business/detail
   uv run python app.py
   ```

2. **åœ¨å‰ç«¯æ¸¬è©¦æœå°‹åŠŸèƒ½**
   - å˜—è©¦æœå°‹é—œéµå­—ï¼ˆä¾‹å¦‚ï¼šã€Œå‰µã€ã€ã€Œé˜¿å‡¡ã€ï¼‰
   - è§€å¯Ÿæ˜¯å¦æˆåŠŸå–å¾—çµæœ

3. **åˆ†æ Debug æ—¥èªŒ**
   å·²åœ¨ç¨‹å¼ç¢¼ä¸­æ·»åŠ è©³ç´°çš„ debug æ—¥èªŒï¼š

   **æˆåŠŸæ™‚é¡¯ç¤º**ï¼š
   - è«‹æ±‚ URL å’Œåƒæ•¸
   - å¯¦éš›ç™¼é€çš„ Cookies
   - å®Œæ•´çš„ Headers
   - å›æ‡‰ç‹€æ…‹ç¢¼å’Œå…§å®¹

   **å¤±æ•—æ™‚é¡¯ç¤º**ï¼š
   - éŒ¯èª¤é¡å‹å’Œè¨Šæ¯
   - HTTP å›æ‡‰ç‹€æ…‹ç¢¼
   - HTTP å›æ‡‰å…§å®¹ï¼ˆå‰ 500 å­—å…ƒï¼‰
   - å®Œæ•´çš„éŒ¯èª¤å †ç–Š (traceback)

4. **æ¯”å°èˆ‡çœŸå¯¦ç€è¦½å™¨çš„å·®ç•°**
   - æª¢æŸ¥ Cookies æ˜¯å¦æ­£ç¢ºå–å¾—
   - æª¢æŸ¥ Headers æ˜¯å¦å®Œæ•´
   - ç¢ºèªæ˜¯å¦é‚„æœ‰éºæ¼çš„é—œéµè³‡è¨Š

### Debug æ—¥èªŒä½ç½®
- **æª”æ¡ˆ**ï¼š`src/web/business/detail/app.py`
- **API 1**ï¼š`@app.route('/api/search-movie')` (ç¬¬ 280 è¡Œèµ·)
- **API 2**ï¼š`@app.route('/api/movie-detail/<movie_id>')` (ç¬¬ 421 è¡Œèµ·)

---

## ğŸš€ æœªä¾†å¯èƒ½çš„æ’éŒ¯æ–¹å‘

### æ–¹æ¡ˆ Aï¼šé€²éšè«‹æ±‚æ¨¡æ“¬
å¦‚æœç•¶å‰æ–¹æ³•ä»ç„¶å¤±æ•—ï¼Œå¯ä»¥å˜—è©¦ï¼š

#### A1. ä½¿ç”¨ Session ä¿æŒé€£ç·š
```python
session = requests.Session()
session.get('https://boxofficetw.tfai.org.tw/')  # å»ºç«‹ session
response = session.get(api_url, headers=headers)
```

#### A2. æ‰‹å‹•è¨­å®šå®Œæ•´çš„ Cookies
å¾ç€è¦½å™¨è¤‡è£½å®Œæ•´çš„ cookies å­—ä¸²ä¸¦æ‰‹å‹•è¨­å®šï¼š
```python
cookies = {
    '_ga': 'GA1.1.1593581343.1759890847',
    '_ga_YJ385WSQ1N': 'GS2.1.s1763291048$o39$g1$t1763291073$j35$l0$h0'
}
scraper.cookies.update(cookies)
```

#### A3. æ·»åŠ éš¨æ©Ÿå»¶é²
æ¨¡æ“¬äººé¡è¡Œç‚ºï¼Œé¿å…è¢«è­˜åˆ¥ç‚ºæ©Ÿå™¨äººï¼š
```python
import random
time.sleep(random.uniform(0.5, 2.0))
```

#### A4. User-Agent è¼ªæ›
ä½¿ç”¨å¤šå€‹ä¸åŒçš„ User-Agent è¼ªæµè«‹æ±‚ï¼š
```python
user_agents = [
    "Mozilla/5.0 ... Chrome/142.0.0.0 ...",
    "Mozilla/5.0 ... Chrome/141.0.0.0 ...",
    "Mozilla/5.0 ... Firefox/120.0 ...",
]
headers['User-Agent'] = random.choice(user_agents)
```

---

### æ–¹æ¡ˆ Bï¼šä½¿ç”¨çœŸå¯¦ç€è¦½å™¨è‡ªå‹•åŒ–
å¦‚æœæ¨¡æ“¬è«‹æ±‚ç„¡æ³•çªç ´ï¼Œè€ƒæ…®ä½¿ç”¨ç„¡é ­ç€è¦½å™¨ï¼š

#### B1. Selenium + undetected-chromedriver
```python
import undetected_chromedriver as uc

driver = uc.Chrome()
driver.get('https://boxofficetw.tfai.org.tw/film/sf?keyword=...')
data = driver.find_element(By.TAG_NAME, "pre").text
```

**å„ªé»**ï¼š
- å®Œå…¨æ¨¡æ“¬çœŸå¯¦ç€è¦½å™¨
- å¯ä»¥é€šé JavaScript æŒ‘æˆ°

**ç¼ºé»**ï¼š
- å•Ÿå‹•æ…¢ï¼ˆ2-5 ç§’ï¼‰
- è³‡æºæ¶ˆè€—å¤§
- éƒ¨ç½²è¤‡é›œï¼ˆéœ€è¦å®‰è£ Chromeï¼‰

#### B2. Playwright
```python
from playwright.sync_api import sync_playwright

with sync_playwright() as p:
    browser = p.chromium.launch()
    page = browser.new_page()
    page.goto('https://boxofficetw.tfai.org.tw/film/sf?keyword=...')
    data = page.content()
```

---

### æ–¹æ¡ˆ Cï¼šå¿«å–èˆ‡å‚™æ´ç­–ç•¥

#### C1. å¯¦ä½œå¿«å–æ©Ÿåˆ¶
æ¸›å°‘å°å¤–éƒ¨ API çš„ä¾è³´ï¼š
```python
# ä½¿ç”¨ Redis æˆ–è¨˜æ†¶é«”å¿«å–
cache_key = f"movie_search:{keyword}"
if cache.exists(cache_key):
    return cache.get(cache_key)

# å¿«å–æœå°‹çµæœ 10 åˆ†é˜
cache.set(cache_key, result, ex=600)
```

#### C2. å»ºç«‹æœ¬åœ°é›»å½±è³‡æ–™åº«
å®šæœŸåŒæ­¥å¤–éƒ¨ API çš„è³‡æ–™åˆ°è‡ªå·±çš„è³‡æ–™åº«ï¼š
- ä½¿ç”¨æ’ç¨‹ä»»å‹™ï¼ˆcronï¼‰æ¯æ—¥åŒæ­¥
- æ¸›å°‘å³æ™‚è«‹æ±‚å¤–éƒ¨ API çš„éœ€æ±‚
- æä¾›ç©©å®šçš„æœå‹™

#### C3. é™ç´šæ–¹æ¡ˆ
ç•¶å¤–éƒ¨ API å¤±æ•—æ™‚ï¼Œæä¾›åŸºæœ¬åŠŸèƒ½ï¼š
```python
try:
    # å˜—è©¦å‘¼å«å¤–éƒ¨ API
    response = scraper.get(api_url, ...)
except Exception:
    # é™ç´šï¼šä½¿ç”¨æœ¬åœ°å¿«å–æˆ–æç¤ºç”¨æˆ¶æ‰‹å‹•è¼¸å…¥
    return jsonify({
        'success': False,
        'error': 'å¤–éƒ¨æœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨ï¼Œè«‹æ‰‹å‹•è¼¸å…¥é›»å½±è³‡æ–™',
        'fallback': True
    })
```

---

### æ–¹æ¡ˆ Dï¼šæ›´æ›å¤–éƒ¨è³‡æ–™ä¾†æº
å¦‚æœ boxofficetw çš„ API æŒçºŒç„¡æ³•ä½¿ç”¨ï¼š

#### D1. å°‹æ‰¾æ›¿ä»£ API
- ç ”ç©¶æ˜¯å¦æœ‰å…¶ä»–å…¬é–‹çš„ç¥¨æˆ¿è³‡æ–™ API
- è€ƒæ…®ä»˜è²»çš„è³‡æ–™æœå‹™

#### D2. ç›´æ¥çˆ¬å–ç¶²é 
å¦‚æœ API ç„¡æ³•ä½¿ç”¨ï¼Œæ”¹ç‚ºçˆ¬å– HTML é é¢ï¼š
```python
# çˆ¬å–æœå°‹é é¢
response = scraper.get('https://boxofficetw.tfai.org.tw/search/...')
soup = BeautifulSoup(response.text, 'html.parser')
# è§£æ HTML æå–è³‡æ–™
```

**æ³¨æ„**ï¼šéœ€è¦å®šæœŸç¶­è­·ï¼ˆç¶²é çµæ§‹å¯èƒ½æ”¹è®Šï¼‰

---

### æ–¹æ¡ˆ Eï¼šèˆ‡å¤–éƒ¨ API æä¾›è€…æºé€š
é•·æœŸæ–¹æ¡ˆï¼š

#### E1. ç”³è«‹å®˜æ–¹ API Key
- è¯ç¹« boxofficetw ç®¡ç†è€…
- èªªæ˜ä½¿ç”¨ç›®çš„
- ç”³è«‹åˆæ³•çš„ API å­˜å–æ¬Šé™

#### E2. äº†è§£ä½¿ç”¨æ¢æ¬¾
- ç¢ºèªæ˜¯å¦å…è¨±è‡ªå‹•åŒ–å­˜å–
- æ˜¯å¦æœ‰é€Ÿç‡é™åˆ¶
- æ˜¯å¦éœ€è¦è¨»æ˜è³‡æ–™ä¾†æº

---

### ç¬¬å››æ¬¡å˜—è©¦:ä½¿ç”¨ curl-cffi (æœ¬åœ°æ¸¬è©¦æˆåŠŸ,éƒ¨ç½²å¤±æ•—)
**æ™‚é–“**:2025-11-16 æ™šä¸Š

**åšæ³•**:
```python
# 1. å®‰è£ curl-cffi
uv add curl-cffi

# 2. ä½¿ç”¨ curl_cffi æ¨¡æ“¬çœŸå¯¦ç€è¦½å™¨çš„ TLS æŒ‡ç´‹
from curl_cffi import requests as curl_requests

session = curl_requests.Session()
session.get("https://boxofficetw.tfai.org.tw/", impersonate="chrome120", timeout=10)

# 3. ç™¼é€è«‹æ±‚æ™‚ä½¿ç”¨ impersonate="chrome120"
response = session.get(api_url, params=params, headers=headers,
                      timeout=15, impersonate="chrome120")
```

**é—œéµç‰¹é»**:
1. âœ… å®Œç¾æ¨¡æ“¬ Chrome 120 çš„ TLS æŒ‡ç´‹
2. âœ… æ”¯æ´ HTTP/2 å”å®š
3. âœ… JA3 æŒ‡ç´‹èˆ‡çœŸå¯¦ç€è¦½å™¨å®Œå…¨ç›¸åŒ
4. âœ… æœ¬åœ°æ¸¬è©¦æˆåŠŸ - å…©å€‹ API éƒ½èƒ½æ­£å¸¸é‹ä½œ

**æ¸¬è©¦çµæœ**:
- âœ… **æœ¬åœ°ç’°å¢ƒ**:æ¸¬è©¦å®Œå…¨é€šé
  - æœå°‹ API:å›æ‡‰ 200,æˆåŠŸæ‰¾åˆ° 4 ç­†çµæœ
  - é›»å½±è©³ç´°è³‡æ–™ API:å›æ‡‰ 200,æˆåŠŸå–å¾—è³‡æ–™
- âŒ **Render.com éƒ¨ç½²**:å¤±æ•—
  - éŒ¯èª¤:`ModuleNotFoundError: No module named 'curl_cffi'`
  - åŸå› :curl-cffi éœ€è¦é ç·¨è­¯çš„äºŒé€²åˆ¶æ–‡ä»¶,åœ¨ Render.com çš„ Linux ç’°å¢ƒç„¡æ³•æ­£ç¢ºå®‰è£

**ç‚ºä»€éº¼æœ¬åœ°æˆåŠŸä½† Render.com å¤±æ•—**:
1. **å®‰è£ä¾è³´ä¸åŒ**:
   - æœ¬åœ° Windows:curl-cffi æœ‰é ç·¨è­¯çš„ wheel
   - Render.com Linux:å¯èƒ½ç¼ºå°‘å¿…è¦çš„ç³»çµ±ä¾è³´æˆ–é ç·¨è­¯ç‰ˆæœ¬
2. **Python/ç³»çµ±ç‰ˆæœ¬**:
   - ä¸åŒç’°å¢ƒçš„ Python ç‰ˆæœ¬ã€OpenSSL ç‰ˆæœ¬å¯èƒ½å°è‡´å®‰è£å¤±æ•—

**çµè«–**:é›–ç„¶ curl-cffi åœ¨æœ¬åœ°æ•ˆæœæ¥µä½³,ä½†åœ¨ç”Ÿç”¢ç’°å¢ƒçš„ç›¸å®¹æ€§å•é¡Œä½¿å…¶ç„¡æ³•ä½¿ç”¨ã€‚

---

### ç¬¬äº”æ¬¡å˜—è©¦:æ”¹ç”¨ requests + å„ªåŒ–ç­–ç•¥(ç•¶å‰ç‰ˆæœ¬)
**æ™‚é–“**:2025-11-16 æ™šä¸Š

**åšæ³•**:
```python
# 1. ç§»é™¤ curl-cffi
uv remove curl-cffi

# 2. æ”¹ç”¨æ¨™æº– requests + ä¸‰å¤§å„ªåŒ–
import requests
import time
import random

session = requests.Session()

# å„ªåŒ– 1: å…ˆè¨ªå•é¦–é å–å¾— cookies
session.get("https://boxofficetw.tfai.org.tw/", timeout=10)

# å„ªåŒ– 2: æ·»åŠ éš¨æ©Ÿå»¶é² (é—œéµ!)
time.sleep(random.uniform(0.3, 0.8))  # æ¨¡æ“¬äººé¡æ€è€ƒæ™‚é–“

# å„ªåŒ– 3: å®Œæ•´çš„ç€è¦½å™¨ headers
headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) ...",
    "Accept": "*/*",
    "Accept-Language": "zh-TW,zh;q=0.9,en-US;q=0.8,en;q=0.7",
    "Accept-Encoding": "gzip, deflate, br",
    "Referer": "https://boxofficetw.tfai.org.tw/",
    "Origin": "https://boxofficetw.tfai.org.tw",
    "sec-ch-ua": '"Not_A Brand";v="8", "Chromium";v="120"...',
    "sec-fetch-dest": "empty",
    "sec-fetch-mode": "cors",
    "sec-fetch-site": "same-origin",
    "x-kl-saas-ajax-request": "Ajax_Request",
    "Connection": "keep-alive",
}

response = session.get(api_url, params=params, headers=headers, timeout=15)
```

**é—œéµæ”¹é€²**:
1. âœ… **éš¨æ©Ÿå»¶é²** - æœ€é‡è¦!æ¨¡æ“¬äººé¡è¡Œç‚º,é™ä½æ©Ÿå™¨äººæª¢æ¸¬æ©Ÿç‡
   - å»¶é²æ™‚é–“:0.3-0.8 ç§’
   - æ¨¡æ“¬çœŸå¯¦ç”¨æˆ¶åœ¨é¦–é å’Œæœå°‹ä¹‹é–“çš„æ€è€ƒæ™‚é–“
2. âœ… **Session ç®¡ç†** - ä¿æŒ cookies å’Œé€£ç·šç‹€æ…‹
3. âœ… **å®Œæ•´ headers** - åŒ…å«æ‰€æœ‰ç€è¦½å™¨ç‰¹å¾µæ¨™é ­
4. âœ… **100% ç›¸å®¹æ€§** - requests æ˜¯ Python å…§å»º,ä¸æœƒæœ‰å®‰è£å•é¡Œ

**å„ªå‹¢**:
- âœ… ä¸éœ€è¦é¡å¤–ä¾è³´,Render.com 100% æ”¯æ´
- âœ… æ·»åŠ äº†ä¹‹å‰æ²’æœ‰çš„éš¨æ©Ÿå»¶é²ç­–ç•¥
- âœ… çµåˆäº†æ–¹æ¡ˆ A(Session ä¿æŒ)å’Œæ–¹æ¡ˆ A3(éš¨æ©Ÿå»¶é²)çš„å„ªé»

**é æœŸæ•ˆæœ**:
- **æˆåŠŸç‡**:æ¯”ç¬¬ä¸‰æ¬¡å˜—è©¦æ›´é«˜(å› ç‚ºåŠ å…¥äº†å»¶é²)
- **ç©©å®šæ€§**:é¿å…äº† curl-cffi çš„å®‰è£å•é¡Œ
- **å¯ç¶­è­·æ€§**:ä½¿ç”¨æ¨™æº–åº«,æ˜“æ–¼é™¤éŒ¯

**çµæœ**:â³ å·²éƒ¨ç½²åˆ° Render.com,ç­‰å¾…æ¸¬è©¦

**Commit**:
```bash
b6f54d6 - ä¿®å¾© curl-cffi å®‰è£å•é¡Œ:æ”¹ç”¨ requests + å„ªåŒ–ç­–ç•¥(æ·»åŠ å»¶é²ã€Session ç®¡ç†)
```

---

## ğŸ“Š å•é¡Œè¿½è¹¤

| é …ç›® | ç‹€æ…‹ | å‚™è¨» |
|------|------|------|
| å•é¡Œç™¼ç¾ | âœ… å·²ç¢ºèª | 403 Forbidden éŒ¯èª¤ |
| åŸå› åˆ†æ | âœ… å·²å®Œæˆ | Cloudflare é˜²è­· + Headers ä¸è¶³ |
| ç¬¬ä¸€æ¬¡ä¿®å¾©å˜—è©¦ | âŒ å¤±æ•— | åŸºæœ¬ headers ä¸è¶³ |
| ç¬¬äºŒæ¬¡ä¿®å¾©å˜—è©¦ | âŒ å¤±æ•— | ç°¡åŒ–ç¨‹å¼ç¢¼æœªè§£æ±ºå•é¡Œ |
| ç¬¬ä¸‰æ¬¡ä¿®å¾©å˜—è©¦ | âŒ å¤±æ•— | å®Œæ•´æ¨¡æ“¬ç€è¦½å™¨è«‹æ±‚(ä»ç„¶è¢« Cloudflare æ””æˆª) |
| ç¬¬å››æ¬¡ä¿®å¾©å˜—è©¦ | âš ï¸ æœ¬åœ°æˆåŠŸ,éƒ¨ç½²å¤±æ•— | curl-cffi:å®‰è£å•é¡Œ |
| ç¬¬äº”æ¬¡ä¿®å¾©å˜—è©¦ | â³ æ¸¬è©¦ä¸­ | requests + å»¶é²å„ªåŒ– |
| Debug æ—¥èªŒæ·»åŠ  | âœ… å·²å®Œæˆ | è©³ç´°çš„è«‹æ±‚/å›æ‡‰æ—¥èªŒ |
| é€²éšæ–¹æ¡ˆç ”ç©¶ | ğŸ“‹ å·²è¦åŠƒ | 5 å€‹å‚™é¸æ–¹æ¡ˆ |

---

## ğŸ”— ç›¸é—œæª”æ¡ˆ

- **å¾Œç«¯ API**ï¼š`src/web/business/detail/app.py`
- **å‰ç«¯ Service**ï¼š`src/web/business/detail/static/js/movieService.js`
- **å‰ç«¯é é¢é‚è¼¯**ï¼š`src/web/business/detail/static/js/predict.js`
- **HTML æ¨¡æ¿**ï¼š`src/web/business/detail/templates/predict_new.html`

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡Œå‹•

1. â³ **åŸ·è¡Œæ¸¬è©¦** - ä½¿ç”¨ç•¶å‰ç‰ˆæœ¬æ¸¬è©¦ä¸¦æ”¶é›† debug æ—¥èªŒ
2. â³ **åˆ†ææ—¥èªŒ** - ç¢ºèª cookiesã€headers æ˜¯å¦æ­£ç¢º
3. â³ **æ ¹æ“šçµæœæ±ºå®š** - å¦‚æœä»ç„¶å¤±æ•—ï¼Œè©•ä¼°é€²éšæ–¹æ¡ˆï¼ˆA/B/C/D/Eï¼‰

---

## ğŸ’¡ ç¶“é©—ç¸½çµ

### é—œéµç™¼ç¾
1. **è‡ªå®šç¾© Header å¾ˆé‡è¦** - `x-kl-saas-ajax-request: Ajax_Request` å¯èƒ½æ˜¯é—œéµé©—è­‰æ©Ÿåˆ¶
2. **Cookies å¿…é ˆå…ˆå–å¾—** - éœ€è¦å…ˆè¨ªå•é¦–é å»ºç«‹ session
3. **æ™‚é–“æˆ³åƒæ•¸** - å¤–éƒ¨ API ä½¿ç”¨æ™‚é–“æˆ³é˜²æ­¢å¿«å–
4. **å®Œæ•´çš„ç€è¦½å™¨ç‰¹å¾µ** - `sec-fetch-*` å’Œ `sec-ch-ua-*` headers ä¸å¯æˆ–ç¼º
5. **éš¨æ©Ÿå»¶é²è‡³é—œé‡è¦** - æ¨¡æ“¬äººé¡è¡Œç‚ºå¯èƒ½æ¯” TLS æŒ‡ç´‹æ›´é‡è¦
6. **ç’°å¢ƒå·®ç•°å½±éŸ¿å·¨å¤§** - æœ¬åœ°æˆåŠŸä¸ä»£è¡¨ç”Ÿç”¢ç’°å¢ƒæˆåŠŸ

### æ•™è¨“
1. **åˆ†æå¯¦éš›è«‹æ±‚** - ä½¿ç”¨ç€è¦½å™¨ DevTools åˆ†ææˆåŠŸçš„è«‹æ±‚æ˜¯æœ€æœ‰æ•ˆçš„æ–¹æ³•
2. **æ·»åŠ  Debug æ—¥èªŒ** - è©³ç´°çš„æ—¥èªŒå°æ’éŒ¯è‡³é—œé‡è¦
3. **äº†è§£åçˆ¬èŸ²æ©Ÿåˆ¶** - Cloudflare çš„æª¢æ¸¬æ©Ÿåˆ¶è¤‡é›œ,éœ€è¦å¤šæ–¹é¢æ¨¡æ“¬
4. **å„ªå…ˆè€ƒæ…®ç›¸å®¹æ€§** - å…ˆç¢ºä¿èƒ½åœ¨ç”Ÿç”¢ç’°å¢ƒé‹è¡Œ,å†è€ƒæ…®æ•ˆæœå„ªåŒ–
5. **æœ¬åœ° vs ç”Ÿç”¢ç’°å¢ƒçš„å·®ç•°**:
   - **IP ä¿¡è­½**:å®¶ç”¨ IP > é›²ç«¯æœå‹™ IP
   - **è«‹æ±‚é »ç‡**:æœ¬åœ°æ¸¬è©¦ä½,ç”Ÿç”¢ç’°å¢ƒé«˜
   - **å¥—ä»¶ç›¸å®¹æ€§**:Windows å’Œ Linux ç’°å¢ƒä¸åŒ

### æŠ€è¡“æ–¹æ¡ˆè©•ä¼°

| æ–¹æ¡ˆ | TLS æŒ‡ç´‹ | æ•ˆæœ | ç›¸å®¹æ€§ | æ¨è–¦åº¦ |
|------|---------|------|--------|--------|
| cloudscraper | â­â­ | âŒ å¤±æ•— | âœ… é«˜ | âŒ |
| curl-cffi | â­â­â­â­â­ | âœ… æœ¬åœ°æˆåŠŸ | âŒ ä½(éƒ¨ç½²å¤±æ•—) | âš ï¸ |
| requests + å»¶é² | â­â­ | â³ æ¸¬è©¦ä¸­ | âœ…âœ… æ¥µé«˜ | âœ… |
| undetected-chromedriver | â­â­â­â­â­ | æœªæ¸¬è©¦ | â­â­ ä¸­(éœ€å®‰è£ Chrome) | â³ å‚™é¸ |

### ç‚ºä»€éº¼æœ¬åœ°æˆåŠŸä½† Render.com å¤±æ•—?

**æ ¸å¿ƒåŸå› **:
1. **IP ä¿¡è­½è©•åˆ†å·®ç•°**
   - æœ¬åœ°(å®¶ç”¨ç¶²è·¯):Cloudflare è©•åˆ†é«˜,æª¢æŸ¥å¯¬é¬†
   - Render.com(é›²ç«¯æœå‹™):è©•åˆ†ä½,æª¢æŸ¥æ¥µåš´æ ¼

2. **TLS æŒ‡ç´‹å·®ç•°**
   - ä¸åŒç’°å¢ƒçš„ Python/OpenSSL ç‰ˆæœ¬ä¸åŒ
   - å°è‡´ TLS æ¡æ‰‹ç‰¹å¾µä¸åŒ

3. **åœ°ç†ä½ç½®**
   - æœ¬åœ°:å°ç£ IP è¨ªå•å°ç£ç¶²ç«™ âœ…
   - Render.com:ç¾åœ‹/æ–°åŠ å¡ IP è¨ªå•å°ç£ç¶²ç«™ âš ï¸

**è§£æ±ºæ€è·¯**:
- æ—¢ç„¶ TLS æŒ‡ç´‹é›£ä»¥å®Œç¾æ¨¡æ“¬(curl-cffi ç„¡æ³•éƒ¨ç½²)
- æ”¹ç‚ºæ¨¡æ“¬**äººé¡è¡Œç‚ºæ¨¡å¼**(éš¨æ©Ÿå»¶é²ã€Session ä¿æŒ)
- å¯èƒ½æ›´å®¹æ˜“é€šé Cloudflare çš„æª¢æ¸¬

### å‚™é¸ç­–ç•¥çš„é‡è¦æ€§
å³ä½¿ç„¡æ³•å®Œç¾æ¨¡æ“¬ç€è¦½å™¨,ä¹Ÿæ‡‰è©²æœ‰:
- **å¿«å–æ©Ÿåˆ¶** - æ¸›å°‘å°å¤–éƒ¨æœå‹™çš„ä¾è³´
- **é™ç´šæ–¹æ¡ˆ** - ä¿è­‰åŸºæœ¬åŠŸèƒ½å¯ç”¨
- **å‚™ç”¨è³‡æ–™æº** - é¿å…å–®é»æ•…éšœ
- **æ‰‹å‹•è¼¸å…¥é¸é …** - ç•¶è‡ªå‹•åŒ–å¤±æ•—æ™‚çš„å‚™æ¡ˆ

---

**æœ€å¾Œæ›´æ–°æ™‚é–“**:2025-11-16 æ™šä¸Š
**ç‹€æ…‹**:ç¬¬äº”æ¬¡ä¿®å¾©å˜—è©¦å·²éƒ¨ç½²,ç­‰å¾…æ¸¬è©¦çµæœ
**ä¸‹ä¸€æ­¥**:
1. ç­‰å¾… Render.com éƒ¨ç½²å®Œæˆ
2. æ¸¬è©¦æœå°‹åŠŸèƒ½æ˜¯å¦æ­£å¸¸
3. å¦‚ä»å¤±æ•—,è€ƒæ…®:
   - å¢åŠ å»¶é²æ™‚é–“(1-2 ç§’)
   - å¯¦ä½œå¿«å–æ©Ÿåˆ¶
   - æä¾›æ‰‹å‹•è¼¸å…¥é™ç´šæ–¹æ¡ˆ
