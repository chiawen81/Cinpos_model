# 工作日誌：模型評估與分群建模方案

**日期**：2025-11-19
**主題**：M1 票房預測模型評估、分群策略與改進方案
**模型版本**：M1_20251110_015910

---

## 一、模型現況評估

### 1.1 模型表現（測試集）

**訓練資料概況**：
- 總樣本數：860 筆（124 部電影）
- 訓練集：647 筆（99 部電影）
- 測試集：213 筆（25 部電影）
- 輪次：全部為首輪

**模型評估結果**：

| 模型 | MAE | RMSE | R² |
|------|-----|------|-----|
| Linear Regression | 967,188 元 | 2,160,924 元 | 0.9560 |
| LightGBM | 1,276,380 元 | 4,260,668 元 | 0.8289 |

### 1.2 關鍵發現

**問題：R² 高但 MAE 大的矛盾**
- R² = 0.956（表現優異）
- MAE = 96.7 萬元（看似很大）

**原因：資料分布極度不均（冪次法則）**

```
目標變數 (amount) 統計：
  平均值：3,121,327 元（約 312 萬）
  中位數：127,374 元（約 12.7 萬）← 只有平均值的 4%！
  標準差：12,020,697 元（約 1,202 萬）← 平均值的 3.85 倍！

  最小值：210 元
  最大值：151,719,934 元（約 1.52 億）

  變異係數 (CV) = 3.85 ← 遠超正態分布 (CV ≈ 0.3)
```

**結論**：
- MAE 相對於平均值 = 96.7 萬 / 312 萬 = **31.0%**
- MAE 相對於標準差 = 96.7 萬 / 1,202 萬 = **8.0%**
- 考慮資料範圍（210 元 ~ 1.5 億元），MAE 其實是合理的

---

## 二、冪次法則驗證

### 2.1 不同分位數的變異貢獻

基於前兩周日均票房的分析（124 部電影）：

| 分群 | 電影數 | 電影佔比 | 票房貢獻 | **變異貢獻** |
|------|--------|---------|----------|-------------|
| PR50+ (前 50%) | 62 部 | 50.0% | 98.0% | **94.0%** |
| PR75+ (前 25%) | 31 部 | 25.0% | 92.7% | **91.9%** |
| PR90+ (前 10%) | 13 部 | 10.5% | 75.5% | **91.1%** |

### 2.2 測試集分層表現

| 電影群 | 樣本數 | MAE | R² | 平均票房 | MAE/平均 |
|--------|--------|-----|-----|---------|----------|
| **PR75+ (大片)** | 99 筆 | 1,819,787 元 | 0.9523 | 6,321,144 元 | 28.8% ✅ |
| **PR75- (小片)** | 114 筆 | 226,773 元 | 0.1439 | 208,745 元 | 108.6% ❌ |

**關鍵洞察**：
1. ✅ **大片預測準確**：MAE 只有平均票房的 28.8%
2. ❌ **小片預測失準**：MAE 比平均票房還大（108.6%）
3. 📊 **R² 被大片主導**：PR75+ 貢獻了整體 R² 的 100.1%

### 2.3 變異貢獻計算方法

```python
# 計算總變異（所有電影）
整體平均值 = 所有電影票房的平均
總變異 = Σ(每部電影票房 - 整體平均值)²

# 計算 PR75+ 的變異貢獻
PR75+ 變異 = Σ(PR75+ 電影票房 - 整體平均值)²  # 注意：仍用整體平均值

# 計算貢獻比例
變異貢獻比例 = PR75+ 變異 / 總變異 × 100%
```

**為什麼 PR75+ 貢獻這麼高？**
- PR75+ 電影票房遠高於整體平均值
- 差距平方後主導了總變異
- 符合「冪次法則」：少數大片主導市場

---

## 三、電影分群策略

### 3.1 分群指標選擇

**候選指標**：
1. ✅ **前兩周日均票房**（推薦）
   - 早期就能判斷量級
   - 預測時可得（不用等首輪結束）
   - 反映初期市場反應

2. ❌ **首輪最終票房**（不可行）
   - 預測時無法得知
   - 違反資訊可得性原則

### 3.2 方案 A：四級分群（推薦）

基於 124 部電影的前兩周日均票房分析：

| 量級 | 分位數範圍 | 日均票房門檻 | 兩周總票房 | 電影數 | 佔比 |
|------|-----------|-------------|-----------|--------|------|
| **小型片** | < P25 | < 45,519 元/天 | < 64 萬 | 31 部 | 25% |
| **中型片** | P25-P75 | 45,519-562,552 元/天 | 64-788 萬 | 62 部 | 50% |
| **大型片** | P75-P90 | 562,552-3,697,180 元/天 | 788-5,176 萬 | 18 部 | 15% |
| **超大型片** | > P90 | >= 3,697,180 元/天 | >= 5,176 萬 | 13 部 | 10% |

**整數門檻版（易記憶）**：
```
小型片  : < 5 萬/天     (< 70 萬/兩周)
中型片  : 5-56 萬/天    (70-784 萬/兩周)
大型片  : 56-370 萬/天  (784-5,180 萬/兩周)
超大型片: >= 370 萬/天  (>= 5,180 萬/兩周)
```

**分群優點**：
- 符合市場分布（中型片最多、超大型片最少）
- 每群樣本數合理（最少 13 部，最多 62 部）
- 可針對超大型片學習「爆款」的特殊衰退模式

---

## 四、簡報質疑與回應

### 4.1 質疑問題

1. **過度擬合（Overfitting）**
2. **MAE 與 R² 所反映的精準度差異過大**

### 4.2 回應策略

#### **問題 1：是否過度擬合？**

**證據顯示：無明顯過度擬合**
- ✅ 模型複雜度低（Linear Regression，19 個特徵）
- ✅ 樣本數/特徵數比例健康（647/19 = 34:1）
- ✅ 測試集 R² = 0.956 表現良好
- ✅ 特徵相關性合理（最重要特徵：boxoffice_week_1，符合邏輯）

**結論**：
> 無明顯過度擬合，但存在「大小片預測能力不均」的問題

#### **問題 2：為什麼 R² 高但 MAE 大？**

**核心原因：冪次法則**
- 少數大片（25%）貢獻了 91.9% 的變異
- R² 被大片「拉高」
- MAE 包含了大量小片的預測誤差

**分層數據證明**：
```
大片（PR75+）：
  MAE/平均 = 28.8%  ← 預測準確 ✅
  R² = 0.95         ← 決定了整體 R²

小片（PR75-）：
  MAE/平均 = 108.6% ← 預測失準 ❌
  R² = 0.14         ← 對整體 R² 幾乎沒影響
```

---

## 五、改進方案：分層建模

### 5.1 核心策略

**採用「方案 A：四級分群」進行分層建模**

```
預測流程：
1. 計算前兩周日均票房
2. 判斷電影屬於哪個量級（小/中/大/超大型片）
3. 使用對應量級的專屬模型進行預測
```

### 5.2 分層建模策略

| 量級 | 模型選擇 | 優化重點 |
|------|---------|---------|
| **超大型片** | XGBoost | 處理極值，容許較大 MAE |
| **大型片** | Linear Regression | 平衡 R² 和 MAE |
| **中型片** | Linear Regression | 主流電影，重點優化 |
| **小型片** | Ridge Regression 或簡單規則 | 正則化防過擬合 |

### 5.3 額外優化措施

**A. 特徵工程強化**
```
針對小片新增：
  ✓ 同量級歷史平均衰退率
  ✓ 檔期擁擠度（同期上映大片數）
  ✓ 口碑指標（若有評分資料）

針對大片新增：
  ✓ 社群討論熱度（若可取得）
  ✓ 系列電影指標（續集、前傳）
```

**B. 評估指標調整**
```
不再只看整體 MAE/R²，改用：
  ✓ 分層 MAE（各量級分別評估）
  ✓ MAPE（平均絕對百分比誤差，標準化誤差）
  ✓ 加權 MAE（大片權重更高）
```

### 5.4 預期改進效果

| 改進項目 | 現況 | 預期改善 |
|---------|------|----------|
| **整體 MAE** | 96.7 萬 | ↓ 20-40%（降至 60-80 萬） |
| **小片 R²** | 0.14 | ↑ 2-3 倍（提升至 0.3-0.5） |
| **大片 MAE/平均** | 28.8% | 維持或改善至 20-25% |
| **可解釋性** | 低 | 高（每層有專屬邏輯） |

---

## 六、關鍵概念釐清

### 6.1 MAE (Mean Absolute Error)

**定義**：
```
MAE = (1/n) × Σ|預測值 - 實際值|
```

**白話文**：
> 每次預測與實際值的差距（不管高估或低估），取平均後的結果

**特性**：
- ✅ 取絕對值（高估低估都算）
- ✅ 單位與原始資料相同（元）
- ✅ 容易理解和解釋
- ✅ 對極端值不敏感（vs RMSE）

**範例**：
```
MAE = 967,188 元
→ 平均每次預測會與實際票房相差 96.7 萬元
→ 可能高估 96.7 萬，也可能低估 96.7 萬
```

### 6.2 R² (決定係數)

**定義**：
```
R² = 1 - (SS_residual / SS_total)
```

**白話文**：
> 模型解釋了多少百分比的變異

**特性**：
- ✅ 相對指標（0-1 之間）
- ✅ 不受資料規模影響
- ⚠️ 在分布不均的資料中，容易被少數極值主導

---

## 七、實施時程

| 階段 | 任務 | 預計時間 |
|------|------|---------|
| **Phase 1** | 資料分層 + 探索性分析 | 3 天 |
| **Phase 2** | 各層級模型訓練與調優 | 5 天 |
| **Phase 3** | 整合測試 + 效果驗證 | 2 天 |
| **Phase 4** | 文件化 + 部署 | 2 天 |
| **總計** | | **12 天** |

---

## 八、參考資料

### 8.1 相關檔案

```
模型檔案：
  data/ML_boxoffice/phase4_models/M1/M1_20251110_015910/

訓練日誌：
  training_log_20251110_015910.txt

訓練資料：
  prepared_data/preprocessed_full.csv

測試結果：
  test_predictions.csv

特徵重要性：
  feature_importance.csv
```

### 8.2 關鍵數據

```
訓練資料：860 筆，124 部電影
測試集：  213 筆，25 部電影

特徵數：  19 個
目標變數：amount（當週票房）

資料範圍：210 元 ~ 1.52 億元（相差 72 萬倍）
變異係數：3.85（極度不均）
```

---

## 九、總結

### 9.1 現況診斷

- ✅ R² 高 (0.956) 但 MAE 大 (96.7 萬) → **正常現象**（冪次法則導致）
- ✅ 無明顯過度擬合 → 但存在**大小片預測能力不均**
- ✅ 大片預測準確（MAE/平均 = 28.8%）
- ❌ 小片預測失準（MAE/平均 = 108.6%）

### 9.2 核心策略

- 採用**方案 A：四級分群**（小/中/大/超大型片）
- 針對不同量級電影使用**專屬模型**
- 強化小片預測能力，維持大片優勢

### 9.3 預期成果

- 整體 MAE ↓ 20-40%
- 小片 R² ↑ 2-3 倍
- 模型可解釋性顯著提升
- 建立符合市場規律的預測系統

---

**記錄者**：Claude Code
**最後更新**：2025-11-19
