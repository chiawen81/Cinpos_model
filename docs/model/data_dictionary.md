# 電影票房預測 - 資料字典

> **版本**: 1.0  
> **更新日期**: 2024-01-XX  
> **用途**: 定義訓練資料的所有欄位，供 AI Agent 和開發者參考

**相關文件**：
- [資料處理規則](data_processing_rules.md) - 輪次定義、週次編號等規則
- [特徵配置](feature_config.yaml) - 機器可讀的特徵定義
- [Pipeline 流程](pipeline.md) - 完整的資料處理流程

---

## 資料結構概述

### 訓練資料格式
- **每一 row**: 代表一個預測樣本
- **預測目標**: 當週票房（target_boxoffice）
- **特徵來源**: 前兩週的歷史資料 + 累積資訊 + 開片實力
- **時間範圍**: 當週之前的所有資訊（不含當週結果）

### 關鍵概念
1. **當週**: 訓練時=已知週次，預測時=要預測的週次
2. **真實週次**: 輪內連續編號（1, 2, 3...），不跳號
3. **活躍週次**: 去除票房=0的週次後重新編號
4. **累積資訊**: 一律截至上週，不包含當週

---

## 欄位定義

### 1. 基本資訊 (3 欄位)

#### gov_id
- **類型**: string
- **說明**: 電影唯一識別碼
- **範例**: "M12345", "AVATAR2023"
- **用途**: 識別電影，用於分組和追蹤
- **注意**: 不用於模型訓練（識別碼）

#### round_idx
- **類型**: integer
- **說明**: 當週所屬的輪次編號
- **取值範圍**: 1, 2, 3, 4, 5...
- **定義**: 
  - 1 = 首輪
  - 2 = 次輪
  - 3 = 三輪...
- **輪次判定規則**: 
  - **輪次結束條件**: 連續 3 週票房 = 0 視為該輪結束
  - **輪次成立條件**: 
    - 真實週次（含輪內票房為0的週次）≥ 3 週
    - 活躍週次（僅計票房>0的週次）≥ 3 週
    - 輪次的最後一週必須有票房（末尾連續票房=0的週次會被移除）
  - **輪次容忍中斷**: 輪次內允許最多連續 2 週票房 = 0（這些週次會保留但不計入活躍週次）
- **資料過濾**:
  - 正式上映日之前的週次不計入任何輪次
  - 不符合成立條件的輪次會被整輪刪除
- **用途**: 
  - 模型特徵（首輪 vs 次輪衰減模式不同）
  - 分輪次建模的依據

#### rounds_cumsum
- **類型**: integer
- **說明**: 該電影已知的累計輪次數
- **取值範圍**: 1-5
- **範例**: 
  - 首輪電影 = 1
  - 次輪電影 = 2
- **用途**: 反映電影的生命週期長度

---

### 2. 當週時間資訊 (4 欄位)

#### current_week_real_idx
- **類型**: integer
- **說明**: 當輪當週的真實週次（輪內連續編號）
- **取值範圍**: 1-52
- **編號規則**: 每輪重新從 1 開始，連續編號
- **範例**:
  - 首輪第 5 週 → current_week_real_idx = 5
  - 次輪第 3 週 → current_week_real_idx = 3
- **注意**: 這是「輪內週次」，不是從首輪第 1 週開始算
- **用途**: 反映當前在該輪的生命週期階段

#### current_week_active_idx
- **類型**: integer
- **說明**: 當輪當週的活躍週次（去除票房=0後重編）
- **取值範圍**: 1-52
- **編號規則**: 砍掉票房=0的週次，剩餘週次重新編號
- **範例**:
```
  真實週次: 1, 2, 3, 5, 6  (第4週票房=0，被砍掉)
  活躍週次: 1, 2, 3, 4, 5  (重新連續編號)
```
- **用途**: 反映實際連續上映的週次

#### gap_real_week_2to1
- **類型**: integer
- **說明**: week_-2 到 week_-1 之間跳過的週次數
- **取值範圍**: 0-5
- **計算公式**: `(week_-1 真實週次) - (week_-2 真實週次) - 1`
- **範例**:
  - week_-2 在真實第 2 週，week_-1 在真實第 3 週 → gap = 0（無跳週）
  - week_-2 在真實第 2 週，week_-1 在真實第 5 週 → gap = 2（跳了第 3, 4 週）
- **用途**: 標記近期是否有中斷上映

#### gap_real_week_1tocurrent
- **類型**: integer
- **說明**: week_-1 到當週之間跳過的週次數
- **取值範圍**: 0-5
- **計算公式**: `(當週真實週次) - (week_-1 真實週次) - 1`
- **用途**: 標記當週前是否有中斷

---

### 3. 近期趨勢 (9 欄位)

#### boxoffice_week_2
- **類型**: float
- **單位**: 元（新台幣）
- **說明**: 兩週前的票房
- **時間點**: 當週的前第 2 個活躍週
- **用途**: 反映近期票房趨勢

#### boxoffice_week_1
- **類型**: float
- **單位**: 元
- **說明**: 上週票房
- **時間點**: 當週的前第 1 個活躍週
- **用途**: 最重要的近期趨勢特徵

#### boxoffice_week_1_PR
- **類型**: float
- **取值範圍**: 0-100
- **說明**: 上週票房的百分位排名（PR, Percentile Rank）
- **計算方式**: 按「年份 × 輪次」分組計算
```python
  df.groupby(['release_year', 'round_idx'])['boxoffice_week_1'].rank(pct=True) * 100
```
- **解讀**: 
  - PR = 90 表示該週票房在同年同輪次中排名前 10%
- **用途**: 反映相對市場熱度

#### audience_week_2
- **類型**: integer
- **單位**: 人次
- **說明**: 兩週前的觀影人數

#### audience_week_1
- **類型**: integer
- **單位**: 人次
- **說明**: 上週觀影人數

#### audience_week_1_PR
- **類型**: float
- **取值範圍**: 0-100
- **說明**: 上週觀影人數的百分位排名
- **計算方式**: 同 boxoffice_week_1_PR

#### screens_week_2
- **類型**: integer
- **說明**: 兩週前的院線數（放映場次數或影廳數）
- **取值範圍**: 0-500

#### screens_week_1
- **類型**: integer
- **說明**: 上週院線數

#### screens_week_1_PR
- **類型**: float
- **取值範圍**: 0-100
- **說明**: 上週院線數的百分位排名

---

### 4. 累積資訊 (6 欄位)

> **重要**: 所有累積欄位均「截至上週，不含當週」

#### boxoffice_cumsum
- **類型**: float
- **單位**: 元
- **說明**: 跨輪累積票房（從首輪第 1 週到上週）
- **計算範圍**: 
  - 首輪電影: sum(首輪第 1 週到上週)
  - 次輪電影: sum(首輪全部 + 次輪第 1 週到上週)
- **注意**: 不包含當週票房
- **用途**: 反映電影整體累積表現

#### boxoffice_round1_cumsum
- **類型**: float
- **單位**: 元
- **說明**: 首輪累積票房
- **計算規則**:
  - 首輪進行中: sum(首輪第 1 週到上週)
  - 首輪已結束: sum(首輪全部週次) = 固定值
- **用途**: 反映首輪表現（開片實力的另一指標）

#### boxoffice_current_round_cumsum
- **類型**: float
- **單位**: 元
- **說明**: 當輪累積票房（當前輪次的累積）
- **計算範圍**: sum(當輪第 1 週到上週)
- **用途**: 反映當前輪次的表現

#### audience_cumsum
- **類型**: integer
- **單位**: 人次
- **說明**: 跨輪累積觀影人數
- **計算範圍**: sum(首輪 + 當輪，截至上週)

#### audience_round1_cumsum
- **類型**: integer
- **說明**: 首輪累積觀影人數

#### audience_current_round_cumsum
- **類型**: integer
- **說明**: 當輪累積觀影人數

---

### 5. 開片實力 (5 欄位)

> **重要**: 所有開片特徵固定指「首輪」，不隨當前輪次改變

#### open_week1_days
- **類型**: integer
- **說明**: 首輪第 1 週的上映天數
- **取值範圍**: 1-7
- **背景**: 
  - 不同電影上映日不同（週四、週一、週六...）
  - 首週可能只有 3-4 天或完整 7 天
- **用途**: 標準化首週票房

#### open_week1_boxoffice
- **類型**: float
- **單位**: 元
- **說明**: 首輪第 1 週票房（原始值）
- **注意**: 受上映天數影響

#### open_week1_boxoffice_daily_avg
- **類型**: float
- **單位**: 元/天
- **說明**: 首輪第 1 週日均票房
- **計算公式**: `open_week1_boxoffice / open_week1_days`
- **用途**: 消除天數差異，反映真實開片實力

#### open_week1_boxoffice_daily_avg_PR
- **類型**: float
- **取值範圍**: 0-100
- **說明**: 首週日均票房的百分位排名
- **計算方式**: 按「年份」分組計算
```python
  df.groupby('release_year')['open_week1_boxoffice_daily_avg'].rank(pct=True) * 100
```
- **為什麼按年份分組**: 不同年份票價、市場規模不同
- **解讀**: PR = 85 表示在該年度所有電影中開片實力排名前 15%

#### open_week2_boxoffice
- **類型**: float
- **單位**: 元
- **說明**: 首輪第 2 週票房
- **用途**: 配合首週票房計算初始衰減趨勢

---

### 6. 市場資訊 (7 欄位)

#### ticket_price_avg_current
- **類型**: float
- **單位**: 元/張
- **說明**: 發行年度的平均票價（依輪次區分）
- **取值規則**:
  - 首輪（round_idx=1）: 該年度首輪平均票價（約 350-380 元）
  - 非首輪（round_idx≥2）: 該年度次輪平均票價（約 150-180 元）
- **範例**:
```
  2023 年首輪: 350 元
  2023 年次輪: 150 元
  2024 年首輪: 360 元
  2024 年次輪: 160 元
```
- **用途**: 
  - 轉換人次與票房（票房 = 人次 × 票價）
  - 標準化不同年份、不同輪次的票房

#### release_year
- **類型**: integer
- **說明**: 首輪上映年份
- **取值範圍**: 2020-2025
- **注意**: 固定為首輪上映年份，不隨輪次改變
- **用途**: 
  - 反映市場環境（不同年份票房規模不同）
  - PR 計算的分組依據

#### release_month
- **類型**: integer
- **說明**: 首輪上映月份
- **取值範圍**: 1-12
- **用途**: 反映檔期效應（暑假、春節檔...）

#### region
- **類型**: categorical (string)
- **說明**: 發行地區
- **可能取值**: "全台", "北部", "中部", "南部"
- **編碼方式**: One-Hot 編碼
- **用途**: 反映地區差異

#### publisher
- **類型**: categorical (string)
- **說明**: 發行商名稱
- **範例**: "華納", "迪士尼", "環球", "甲上"...
- **編碼方式**: One-Hot 編碼（建議保留前 10-15 大發行商，其他合併為"其他"）
- **用途**: 反映宣傳力度和發行策略

#### is_restricted
- **類型**: boolean (0/1)
- **說明**: 是否為限制級電影
- **取值**: 
  - 0 = 否（普遍級、保護級、輔導級）
  - 1 = 是（限制級）
- **用途**: 限制級觀眾群較窄，可能影響票房

#### film_length
- **類型**: integer
- **單位**: 分鐘
- **說明**: 片長

---

### 7. 目標變數 (1 欄位)

#### target_boxoffice
- **類型**: float
- **單位**: 元
- **說明**: 當週票房（預測目標）
- **取值範圍**: 0-10000
- **訓練階段**: 已知值（答案）
- **預測階段**: 未知值（要預測的目標）
- **注意**: 這是唯一的預測目標，其他欄位都是特徵

---

## 附錄

### A. 資料範例
```csv
movie_id,round_idx,current_week_real_idx,current_week_active_idx,boxoffice_week_1,target_boxoffice
M001,1,3,3,3500,2500
M001,1,4,4,2500,1800
M002,2,3,3,600,450
```

### B. 常見問題

**Q: 為什麼累積不包含當週？**
A: 預測時當週票房未知，無法計算包含當週的累積。訓練和預測必須使用相同的資訊。

**Q: 為什麼開片特徵不隨輪次改變？**
A: 開片實力反映電影的初始吸引力，應該用首輪表現。次輪的「首週」受首輪影響，不是真正的開片實力。

**Q: 真實週次 vs 活躍週次的差異？**
A: 真實週次是輪內連續編號，活躍週次是去除票房=0後重編。兩者都有價值，分別反映時間流逝和實際上映週數。

---

## 更新日誌

- **v1.0** (2024-01-XX): 初始版本，定義 33 個特徵 + 1 個目標變數