# 電影票房預測模型優化路線圖

> **版本**: 1.0
> **最後更新**: 2025-11-20
> **用途**: 記錄模型評估結果、核心問題分析與未來優化方案

---

## 📋 目錄

- [模型現況評估](#模型現況評估)
- [核心問題分析](#核心問題分析)
- [優化方案一：電影分群策略](#優化方案一電影分群策略)
- [優化方案二：預測停止條件](#優化方案二預測停止條件)
- [優化方案三：分層建模策略](#優化方案三分層建模策略)
- [實施時程](#實施時程)
- [參考資料](#參考資料)

---

## 模型現況評估

### 當前模型資訊

- **模型類型**: Linear Regression (線性迴歸)
- **模型版本**: M1_20251110_015910
- **特徵數量**: 19 個
- **訓練樣本數**: 860 筆（124 部電影）
- **測試樣本數**: 213 筆（25 部電影）
- **資料範圍**: 全部為首輪電影

### 模型表現（測試集）

| 模型 | MAE | RMSE | R² |
|------|-----|------|-----|
| Linear Regression | 967,188 元 | 2,160,924 元 | 0.9560 |
| LightGBM | 1,276,380 元 | 4,260,668 元 | 0.8289 |

### 關鍵發現

**表面矛盾**：
- ✅ R² = 0.956（表現優異）
- ⚠️ MAE = 96.7 萬元（看似很大）

**矛盾原因**：資料分布極度不均（冪次法則）

```
目標變數 (amount) 統計：
  平均值：3,121,327 元（約 312 萬）
  中位數：127,374 元（約 12.7 萬）← 只有平均值的 4%！
  標準差：12,020,697 元（約 1,202 萬）← 平均值的 3.85 倍！

  最小值：210 元
  最大值：151,719,934 元（約 1.52 億）← 相差 72 萬倍！

  變異係數 (CV) = 3.85 ← 遠超正態分布 (CV ≈ 0.3)
```

**結論**：
- MAE 相對於平均值 = 96.7 萬 / 312 萬 = **31.0%**
- MAE 相對於標準差 = 96.7 萬 / 1,202 萬 = **8.0%**
- 考慮資料範圍（210 元 ~ 1.5 億元），MAE 其實是合理的

---

## 核心問題分析

### 問題一：冪次法則主導資料分布

基於前兩周日均票房的分析（124 部電影）：

| 電影群 | 電影數 | 電影佔比 | 票房貢獻 | **變異貢獻** |
|--------|--------|---------|----------|-------------|
| PR50+ (前 50%) | 62 部 | 50.0% | 98.0% | **94.0%** |
| PR75+ (前 25%) | 31 部 | 25.0% | 92.7% | **91.9%** |
| PR90+ (前 10%) | 13 部 | 10.5% | 75.5% | **91.1%** |

**關鍵洞察**：
- 少數大片（25%）貢獻了 **91.9% 的變異**
- R² 被大片主導，容易產生「假象優異」

### 問題二：大小片預測能力嚴重不均

測試集分層表現：

| 電影群 | 樣本數 | MAE | R² | 平均票房 | MAE/平均 |
|--------|--------|-----|-----|---------|----------|
| **PR75+ (大片)** | 99 筆 | 1,819,787 元 | 0.9523 | 6,321,144 元 | 28.8% ✅ |
| **PR75- (小片)** | 114 筆 | 226,773 元 | 0.1439 | 208,745 元 | 108.6% ❌ |

**結論**：
1. ✅ **大片預測準確**：MAE 只有平均票房的 28.8%
2. ❌ **小片預測失準**：MAE 比平均票房還大（108.6%）
3. 📊 **R² 被大片主導**：PR75+ 貢獻了整體 R² 的 100.1%

### 問題三：週票房分布極度不均

統計結果：
```
週票房 < 5萬：315 筆（36.6%）
  └─ < 1萬：128 筆（14.9%）
  └─ 1-5萬：187 筆（21.7%）

週票房 ≥ 5萬：545 筆（63.4%）
```

---

## 優化方案一：電影分群策略

### 1. 分群指標選擇

**推薦指標：前兩周日均票房**

**優點**：
- ✅ 早期就能判斷量級
- ✅ 預測時可得（不用等首輪結束）
- ✅ 反映初期市場反應
- ✅ 更穩定：不受首週特殊檔期影響
- ✅ 考慮趨勢：能反映電影的口碑效應
- ✅ 平滑異常：避免首週放映天數差異

**不推薦：首輪最終票房**
- ❌ 預測時無法得知
- ❌ 違反資訊可得性原則

### 2. 方案 A：四級分群（推薦）

基於 124 部電影的分析：

| 量級 | 分位數範圍 | 日均票房門檻 | 兩周總票房 | 電影數 | 佔比 |
|------|-----------|-------------|-----------|--------|------|
| **小型片** | < P25 | < 5 萬元/天 | < 70 萬 | 31 部 | 25% |
| **中型片** | P25-P75 | 5-56 萬元/天 | 70-784 萬 | 62 部 | 50% |
| **大型片** | P75-P90 | 56-370 萬元/天 | 784-5,180 萬 | 18 部 | 15% |
| **超大型片** | > P90 | >= 370 萬元/天 | >= 5,180 萬 | 13 部 | 10% |

**分群優點**：
- ✅ 符合市場分布（中型片最多、超大型片最少）
- ✅ 每群樣本數合理（最少 13 部，最多 62 部）
- ✅ 可針對超大型片學習「爆款」的特殊衰退模式

### 3. 不同級別的衰退模式驗證

各級別的中位數衰退率：

| 量級 | 中位數衰退率 | 特性 |
|------|-------------|------|
| 小型片 (< 5萬/天) | -57.6% | 衰退最快 |
| 中型片 (5-56萬/天) | -48.8% | 衰退中等 |
| 大型片 (56-370萬/天) | -50.4% | 衰退穩定 |
| 超大型片 (>= 370萬/天) | -41.3% | 衰退最慢 |

**重要發現**：
- ✅ 小片平均衰退 57-61%，大片只衰退 41-44%
- ✅ 證明「加入級別特徵」可以幫助模型學習不同的衰退模式！

### 4. 實作建議

```python
def add_tier_features(features):
    """加入票房級別特徵（基於首兩週日均票房）"""
    # 計算首兩週日均票房
    first_two_weeks_daily_avg = (
        features['open_week1_boxoffice'] +
        features['open_week2_boxoffice']
    ) / 14

    # 方案 A 的分界點（整數門檻版）
    if first_two_weeks_daily_avg < 50000:
        tier = 0  # 小型片
        tier_name = '小型片'
    elif first_two_weeks_daily_avg < 560000:
        tier = 1  # 中型片
        tier_name = '中型片'
    elif first_two_weeks_daily_avg < 3700000:
        tier = 2  # 大型片
        tier_name = '大型片'
    else:
        tier = 3  # 超大型片
        tier_name = '超大型片'

    features['movie_tier'] = tier
    features['first_two_weeks_daily_avg'] = first_two_weeks_daily_avg

    # 加入級別 one-hot encoding（讓模型更容易學習）
    features['is_small_movie'] = 1 if tier == 0 else 0
    features['is_medium_movie'] = 1 if tier == 1 else 0
    features['is_large_movie'] = 1 if tier == 2 else 0
    features['is_super_movie'] = 1 if tier == 3 else 0

    return features
```

---

## 優化方案二：預測停止條件

### 問題分析

- 週票房 < 5萬：315 筆（36.6%）← 比例很高
- 單一門檻（5萬）會導致過早停止預測

### 建議的智能停止條件

```python
def should_stop_prediction(predictions, week_data):
    """智能停止條件"""
    if len(predictions) == 0:
        return False

    latest_pred = predictions[-1]['predicted_boxoffice']

    # 條件 1: 低於 3 萬
    if latest_pred < 30000:
        return True

    # 條件 2: 連續兩週都低於 5 萬
    if len(predictions) >= 2:
        if (predictions[-1]['predicted_boxoffice'] < 50000 and
            predictions[-2]['predicted_boxoffice'] < 50000):
            return True

    # 條件 3: 已經上映很久（>8週）且票房 < 5 萬
    if len(week_data) + len(predictions) > 8 and latest_pred < 50000:
        return True

    return False
```

### 停止條件說明

| 條件 | 門檻 | 影響比例 | 適用情境 |
|------|------|---------|---------|
| **條件 1** | < 3萬 | ~25% | 票房極低，無預測價值 |
| **條件 2** | 連續兩週 < 5萬 | ~15% | 持續低迷，下檔在即 |
| **條件 3** | 上映 >8週 且 < 5萬 | ~10% | 長尾小片，自然結束 |

---

## 優化方案三：分層建模策略

### 1. 核心策略

**採用「四級分群」進行分層建模**

```
預測流程：
1. 計算前兩周日均票房
2. 判斷電影屬於哪個量級（小/中/大/超大型片）
3. 使用對應量級的專屬模型進行預測
```

### 2. 分層建模配置

| 量級 | 模型選擇 | 優化重點 | 理由 |
|------|---------|---------|------|
| **超大型片** | XGBoost | 處理極值，容許較大 MAE | 爆款規律複雜，需非線性模型 |
| **大型片** | Linear Regression | 平衡 R² 和 MAE | 數據充足，線性關係明顯 |
| **中型片** | Linear Regression | 主流電影，重點優化 | 樣本最多，預測最關鍵 |
| **小型片** | Ridge Regression | 正則化防過擬合 | 樣本少，需防止過擬合 |

### 3. 特徵工程強化

**針對小片新增**：
- ✓ 同量級歷史平均衰退率
- ✓ 檔期擁擠度（同期上映大片數）
- ✓ 口碑指標（若有評分資料）

**針對大片新增**：
- ✓ 社群討論熱度（若可取得）
- ✓ 系列電影指標（續集、前傳）
- ✓ 明星卡司指標

### 4. 評估指標調整

**不再只看整體 MAE/R²，改用**：
- ✓ **分層 MAE**：各量級分別評估
- ✓ **MAPE**：平均絕對百分比誤差（標準化誤差）
- ✓ **加權 MAE**：大片權重更高（符合商業價值）

```python
# 加權 MAE 計算
weighted_mae = (
    0.1 * mae_small +    # 小型片權重 10%
    0.3 * mae_medium +   # 中型片權重 30%
    0.3 * mae_large +    # 大型片權重 30%
    0.3 * mae_super      # 超大型片權重 30%
)
```

### 5. 預期改進效果

| 改進項目 | 現況 | 預期改善 |
|---------|------|----------|
| **整體 MAE** | 96.7 萬 | ↓ 20-40%（降至 60-80 萬） |
| **小片 R²** | 0.14 | ↑ 2-3 倍（提升至 0.3-0.5） |
| **小片 MAE/平均** | 108.6% | ↓ 至 50-70% |
| **大片 MAE/平均** | 28.8% | 維持或改善至 20-25% |
| **可解釋性** | 低 | 高（每層有專屬邏輯） |

---

## 實施時程

| 階段 | 任務 | 預計時間 | 交付成果 |
|------|------|---------|---------|
| **Phase 1** | 資料分層 + 探索性分析 | 3 天 | 分層統計報告 |
| **Phase 2** | 各層級模型訓練與調優 | 5 天 | 4 個專屬模型 |
| **Phase 3** | 整合測試 + 效果驗證 | 2 天 | 對比測試報告 |
| **Phase 4** | 文件化 + 部署 | 2 天 | 更新規格文件 |
| **總計** | | **12 天** | |

---

## 參考資料

### 相關檔案

```
模型檔案：
  data/ML_boxoffice/phase4_models/M1/M1_20251110_015910/

訓練日誌：
  training_log_20251110_015910.txt

訓練資料：
  prepared_data/preprocessed_full.csv

測試結果：
  test_predictions.csv

特徵重要性：
  feature_importance.csv
```

### 關鍵數據摘要

```
訓練資料：860 筆，124 部電影
測試集：  213 筆，25 部電影

特徵數：  19 個
目標變數：amount（當週票房）

資料範圍：210 元 ~ 1.52 億元（相差 72 萬倍）
變異係數：3.85（極度不均）
```

### 相關文件

- [模型規格文件](../spec_model.md) - 模型整體說明
- [Pipeline 流程](./data_資料處理流程.md) - 資料處理流程
- [資料欄位定義](./data_資料欄位定義.md) - 特徵說明
- [資料處理規則](./data_資料處理規則.md) - 處理規則

---

## 總結

### 核心診斷

- ✅ R² 高 (0.956) 但 MAE 大 (96.7 萬) → **正常現象**（冪次法則導致）
- ✅ 無明顯過度擬合 → 但存在**大小片預測能力不均**
- ✅ 大片預測準確（MAE/平均 = 28.8%）
- ❌ 小片預測失準（MAE/平均 = 108.6%）

### 優化策略

1. **電影分群**：採用四級分群（小/中/大/超大型片）
2. **預測停止**：智能停止條件（避免無效預測）
3. **分層建模**：針對不同量級使用專屬模型

### 預期成果

- 整體 MAE ↓ 20-40%
- 小片 R² ↑ 2-3 倍
- 模型可解釋性顯著提升
- 建立符合市場規律的預測系統

---

**文件性質**：未來優化參考
**優先級**：高（核心改進方向）
**最後更新**：2025-11-20
