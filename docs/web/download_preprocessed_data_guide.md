# ä¸‹è¼‰é è™•ç†è³‡æ–™åŠŸèƒ½èªªæ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

**ç›®çš„**: å°‡ Web ç«¯è¼¸å…¥çš„é€±æ¬¡è³‡æ–™ç¶“éèˆ‡è¨“ç·´éšæ®µç›¸åŒçš„ç‰¹å¾µå·¥ç¨‹è™•ç†å¾Œï¼ŒåŒ¯å‡ºç‚º CSV æª”æ¡ˆï¼Œç”¨æ–¼é©—è­‰è³‡æ–™ä¸€è‡´æ€§ã€‚

**é©ç”¨å ´æ™¯**:
- é©—è­‰ Web ç«¯çš„ç‰¹å¾µå·¥ç¨‹æ˜¯å¦èˆ‡è¨“ç·´éšæ®µä¸€è‡´
- Debug é æ¸¬ä¸æº–ç¢ºçš„å•é¡Œ
- æ¯”å°è¨“ç·´è³‡æ–™èˆ‡å¯¦éš›æ‡‰ç”¨è³‡æ–™çš„å·®ç•°

---

## ğŸ¯ ä½¿ç”¨æ–¹å¼

### 1. é€²å…¥æ–°é›»å½±é æ¸¬é é¢

è¨ªå•: `http://localhost:5000/predict-new`

### 2. è¼¸å…¥é›»å½±è³‡æ–™

æœ€å°‘éœ€è¦è¼¸å…¥ **3 é€±çš„è³‡æ–™**ï¼ˆå› ç‚ºç‰¹å¾µè¨ˆç®—éœ€è¦å‰2é€±ä½œç‚º lag featuresï¼‰

**å¿…å¡«æ¬„ä½**:
- é€±æ¬¡ (week)
- ç¥¨æˆ¿ (boxoffice) - å¿…é ˆå¤§æ–¼ 0
- è§€å½±äººæ¬¡ (audience) - é¸å¡«ï¼Œè‹¥ç‚ºç©ºå‰‡æœƒç”¨ç¥¨æˆ¿/300ä¼°ç®—
- é™¢ç·šæ•¸ (screens) - é¸å¡«ï¼Œè‹¥ç‚ºç©ºå‰‡é è¨­ç‚º 100

**é›»å½±åŸºæœ¬è³‡è¨Š** (é¸å¡«ï¼Œè‹¥æœªé¸æ“‡é›»å½±å‰‡ä½¿ç”¨é è¨­å€¼):
- é›»å½±åç¨±
- ä¸Šæ˜ æ—¥æœŸ
- ç‰‡é•·
- æ˜¯å¦é™åˆ¶ç´š

### 3. é»æ“Šã€Œä¸‹è¼‰é è™•ç†è³‡æ–™ã€æŒ‰éˆ•

æŒ‰éˆ•ä½ç½®: åœ¨ã€Œ+ æ–°å¢ä¸€é€±ã€æŒ‰éˆ•æ—é‚Š

### 4. å–å¾— CSV æª”æ¡ˆ

æª”æ¡ˆåç¨±æ ¼å¼: `{é›»å½±åç¨±}_preprocessed_{æ™‚é–“æˆ³è¨˜}.csv`

---

## ğŸ“Š CSV æª”æ¡ˆæ ¼å¼

åŒ¯å‡ºçš„ CSV æª”æ¡ˆèˆ‡è¨“ç·´æ™‚çš„ `preprocessed_full.csv` **å®Œå…¨ç›¸åŒ**ï¼š

### æ¬„ä½åˆ—è¡¨ (21å€‹æ¬„ä½)

| æ¬„ä½åç¨± | èªªæ˜ | ç¯„ä¾‹å€¼ |
|---------|------|--------|
| `gov_id` | æ”¿åºœé›»å½±ä»£è™Ÿ (webè¼¸å…¥å›ºå®šç‚º'web_input') | web_input |
| `round_idx` | è¼ªæ¬¡ç·¨è™Ÿ (æ–°é›»å½±å›ºå®šç‚º1) | 1 |
| `current_week_active_idx` | ç•¶å‰æ´»èºé€±æ¬¡ | 3.0 |
| `gap_real_week_2to1` | å‰2é€±åˆ°å‰1é€±çš„è·³é€±æ•¸ | 0 |
| `gap_real_week_1tocurrent` | å‰1é€±åˆ°ç•¶å‰é€±çš„è·³é€±æ•¸ | 0 |
| `boxoffice_week_2` | å‰2é€±ç¥¨æˆ¿ | 12000000.0 |
| `boxoffice_week_1` | å‰1é€±ç¥¨æˆ¿ | 10200000.0 |
| `audience_week_2` | å‰2é€±è§€å½±äººæ¬¡ | 40000.0 |
| `audience_week_1` | å‰1é€±è§€å½±äººæ¬¡ | 34000.0 |
| `screens_week_2` | å‰2é€±é™¢ç·šæ•¸ | 150.0 |
| `screens_week_1` | å‰1é€±é™¢ç·šæ•¸ | 140.0 |
| `open_week1_days` | é¦–é€±æ”¾æ˜ å¤©æ•¸ | 7 |
| `open_week1_boxoffice` | é¦–é€±ç¥¨æˆ¿ | 15000000.0 |
| `open_week1_boxoffice_daily_avg` | é¦–é€±æ—¥å‡ç¥¨æˆ¿ | 2142857.1428 |
| `open_week2_boxoffice` | ç¬¬äºŒé€±ç¥¨æˆ¿ | 12000000.0 |
| `amount` | ç•¶é€±å¯¦éš›ç¥¨æˆ¿ (ç›®æ¨™è®Šæ•¸) | 9500000.0 |
| `release_year` | ä¸Šæ˜ å¹´ä»½ | 2024 |
| `film_length` | ç‰‡é•· (åˆ†é˜) | 120 |
| `is_restricted` | æ˜¯å¦é™åˆ¶ç´š (0/1) | 0 |
| `release_month_sin` | æœˆä»½æ­£å¼¦ç·¨ç¢¼ | -0.5000 |
| `release_month_cos` | æœˆä»½é¤˜å¼¦ç·¨ç¢¼ | 0.8660 |

---

## ğŸ” é©—è­‰æ–¹æ³•

### æ­¥é©Ÿ 1: æº–å‚™æ¯”å°è³‡æ–™

1. **è¨“ç·´è³‡æ–™**: å¾è¨“ç·´æ™‚ç”Ÿæˆçš„ `preprocessed_full.csv` ä¸­é¸å–ä¸€éƒ¨é›»å½±
2. **Web è³‡æ–™**: åœ¨ Web ä»‹é¢è¼¸å…¥åŒä¸€éƒ¨é›»å½±çš„ç›¸åŒé€±æ¬¡è³‡æ–™

### æ­¥é©Ÿ 2: ä¸‹è¼‰ä¸¦æ¯”å°

```python
import pandas as pd

# è®€å–è¨“ç·´è³‡æ–™
train_data = pd.read_csv('data/ML_boxoffice/phase4_models/M1/M1_20251110_015910/prepared_data/preprocessed_full.csv')

# è®€å– Web ä¸‹è¼‰çš„è³‡æ–™
web_data = pd.read_csv('é›»å½±åç¨±_preprocessed_20241113_123456.csv')

# ç¯©é¸åŒä¸€éƒ¨é›»å½±
movie_id = '13460'  # æ›¿æ›ç‚ºå¯¦éš›çš„ gov_id
train_movie = train_data[train_data['gov_id'] == int(movie_id)]
web_movie = web_data[web_data['gov_id'] == 'web_input']  # Web è¼¸å…¥å›ºå®šç‚ºå­—ä¸²

# æ¯”å°ç‰¹å¾µå€¼
print("è¨“ç·´è³‡æ–™å‰5è¡Œ:")
print(train_movie.head())

print("\nWeb è³‡æ–™å‰5è¡Œ:")
print(web_movie.head())

# æª¢æŸ¥æ•¸å€¼å·®ç•°
feature_columns = [
    'boxoffice_week_1', 'boxoffice_week_2',
    'open_week1_boxoffice', 'release_month_sin', 'release_month_cos'
]

for col in feature_columns:
    train_val = train_movie[col].iloc[0]
    web_val = web_movie[col].iloc[0]
    diff = abs(train_val - web_val)
    print(f"{col}: train={train_val:.2f}, web={web_val:.2f}, diff={diff:.6f}")
```

### æ­¥é©Ÿ 3: æª¢æŸ¥ä¸€è‡´æ€§

**âœ… æ­£å¸¸æƒ…æ³**:
- ç‰¹å¾µå€¼æ‡‰è©²å®Œå…¨ä¸€è‡´ï¼ˆæˆ–å·®ç•°åœ¨æµ®é»æ•¸èª¤å·®ç¯„åœå…§ï¼Œ< 0.0001ï¼‰
- æ¬„ä½é †åºå®Œå…¨ç›¸åŒ
- è³‡æ–™å‹åˆ¥ä¸€è‡´

**âŒ ç•°å¸¸æƒ…æ³**:
- ç‰¹å¾µå€¼æœ‰æ˜é¡¯å·®ç•° â†’ æª¢æŸ¥ç‰¹å¾µå·¥ç¨‹é‚è¼¯
- æ¬„ä½ç¼ºå¤±æˆ–é †åºä¸åŒ â†’ æª¢æŸ¥æ¬„ä½å®šç¾©
- æ•¸å€¼å‹åˆ¥ä¸ä¸€è‡´ â†’ æª¢æŸ¥è³‡æ–™é¡å‹è½‰æ›

---

## ğŸ› å¸¸è¦‹å•é¡Œ

### Q1: ç‚ºä»€éº¼ä¸‹è¼‰æŒ‰éˆ•æ˜¯ç°è‰²çš„ï¼Ÿ
**A**: è¡¨æ ¼è³‡æ–™é©—è­‰æœªé€šéï¼Œè«‹æª¢æŸ¥ï¼š
- æ˜¯å¦è‡³å°‘æœ‰ 3 é€±è³‡æ–™
- æ¯é€±çš„ç¥¨æˆ¿æ¬„ä½æ˜¯å¦å¡«å¯«ä¸”å¤§æ–¼ 0

### Q2: ä¸‹è¼‰çš„æª”æ¡ˆåªæœ‰ header æ²’æœ‰è³‡æ–™ï¼Ÿ
**A**: è¡¨ç¤ºè¼¸å…¥çš„é€±æ¬¡è³‡æ–™å°‘æ–¼ 3 é€±ã€‚é è™•ç†è³‡æ–™å¾ç¬¬ 3 é€±é–‹å§‹è¨ˆç®—ï¼ˆå› ç‚ºéœ€è¦å‰2é€±ä½œç‚ºç‰¹å¾µï¼‰ã€‚

### Q3: å¦‚ä½•ç¢ºèªè³‡æ–™æ­£ç¢ºæ€§ï¼Ÿ
**A**:
1. æª¢æŸ¥ CSV æª”æ¡ˆçš„è¡Œæ•¸ = è¼¸å…¥é€±æ•¸ - 2ï¼ˆä¾‹å¦‚è¼¸å…¥5é€±ï¼Œæ‡‰è©²æœ‰3è¡Œè³‡æ–™ï¼‰
2. æª¢æŸ¥æ¯ä¸€è¡Œçš„ `current_week_active_idx` æ‡‰è©²å¾ 3 é–‹å§‹éå¢
3. æª¢æŸ¥ `amount` (ç›®æ¨™è®Šæ•¸) æ˜¯å¦å°æ‡‰æ­£ç¢ºçš„é€±æ¬¡

### Q4: CSV æª”æ¡ˆå¯ä»¥ç›´æ¥ç”¨æ–¼æ¨¡å‹è¨“ç·´å—ï¼Ÿ
**A**: å¯ä»¥ï¼Œä½†éœ€è¦æ³¨æ„ï¼š
- `gov_id` æ¬„ä½åœ¨ Web è¼¸å…¥æ™‚ç‚ºå­—ä¸² 'web_input'ï¼Œè¨“ç·´æ™‚ç‚ºæ•¸å­—
- å–®ä¸€é›»å½±çš„è³‡æ–™é‡å¤ªå°‘ï¼Œä¸é©åˆå–®ç¨è¨“ç·´
- å»ºè­°ç”¨æ–¼é©—è­‰å’Œ debugï¼Œè€Œéè¨“ç·´

---

## ğŸ“ æŠ€è¡“ç´°ç¯€

### è³‡æ–™è™•ç†æµç¨‹

```
å‰ç«¯è¼¸å…¥ (predict.js)
    â†“
æ”¶é›†é€±æ¬¡è³‡æ–™ + é›»å½±è³‡è¨Š
    â†“
POST /api/predict-new/download-preprocessed
    â†“
prediction_service.export_preprocessed_data()
    â†“
ä½¿ç”¨ BoxOfficeFeatureEngineer é€²è¡Œç‰¹å¾µå·¥ç¨‹
    â†“
ç”Ÿæˆèˆ‡ preprocessed_full.csv ç›¸åŒæ ¼å¼çš„ DataFrame
    â†“
åŒ¯å‡ºç‚º CSV ä¸¦è¿”å›çµ¦å‰ç«¯
    â†“
ç€è¦½å™¨ä¸‹è¼‰æª”æ¡ˆ
```

### ç‰¹å¾µè¨ˆç®—é‚è¼¯

æ‰€æœ‰ç‰¹å¾µè¨ˆç®—éƒ½ä½¿ç”¨å…±ç”¨æ¨¡çµ„ `feature_engineering.py`ï¼Œç¢ºä¿èˆ‡è¨“ç·´æ™‚ä¸€è‡´ï¼š

1. **æœˆä»½ç·¨ç¢¼**: `encode_month_cyclical()` - sin/cos é€±æœŸæ€§ç·¨ç¢¼
2. **é–‹ç‰‡å¯¦åŠ›**: `calculate_opening_strength()` - é¦–é€±ç›¸é—œæŒ‡æ¨™
3. **Lag Features**: `calculate_lag_features()` - å‰1é€±ã€å‰2é€±æ•¸æ“š
4. **å®Œæ•´ç‰¹å¾µ**: `build_prediction_features()` - æ•´åˆæ‰€æœ‰ç‰¹å¾µ

---

## âœ… é©—è­‰æª¢æŸ¥æ¸…å–®

- [ ] CSV æª”æ¡ˆæ¬„ä½æ•¸é‡ç‚º 21 å€‹
- [ ] æ¬„ä½é †åºèˆ‡ `preprocessed_full.csv` ä¸€è‡´
- [ ] `release_month_sin` å’Œ `release_month_cos` çš„å€¼åœ¨ [-1, 1] ç¯„åœå…§
- [ ] `open_week1_boxoffice` ç­‰æ–¼ç¬¬1é€±çš„ç¥¨æˆ¿
- [ ] `boxoffice_week_1` å’Œ `boxoffice_week_2` å°æ‡‰æ­£ç¢ºçš„é€±æ¬¡
- [ ] æ¯è¡Œçš„ `amount` å°æ‡‰è©²é€±çš„å¯¦éš›ç¥¨æˆ¿
- [ ] `current_week_active_idx` å¾ 3 é–‹å§‹é€£çºŒéå¢

---

**å»ºç«‹æ—¥æœŸ**: 2025-11-13
**é©ç”¨ç‰ˆæœ¬**: v1.0+
