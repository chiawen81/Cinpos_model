{% extends "base.html" %}

{% block title %}{{ movie.title }} - ç¥¨æˆ¿é æ¸¬è©³æƒ…{% endblock %}

{% block content %}
<!-- é é¢æ¨™é¡Œ -->
<div class="mb-4" style="display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h1>{{ movie.title }}</h1>
        <p class="text-secondary">ç¥¨æˆ¿é æ¸¬èˆ‡è¶¨å‹¢åˆ†æ</p>
    </div>
    <button class="btn-track" id="trackButton" data-gov-id="{{ movie.gov_id }}" data-title="{{ movie.title }}">
        <svg class="track-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14M5 12h14"></path>
        </svg>
        <span class="track-text">è¿½è¹¤</span>
    </button>
</div>

<!-- é è­¦æç¤º -->
{% if warning.has_warning %}
<div class="alert alert-warning">
    <span class="alert-icon">âš </span>
    <div class="alert-content">
        <div class="alert-title">ç¥¨æˆ¿è¡°é€€é è­¦</div>
        <div class="alert-message">{{ warning.message }}</div>
    </div>
</div>
{% endif %}

<!-- é—œéµæŒ‡æ¨™å¡ç‰‡ï¼ˆç§»åˆ°æœ€ä¸Šæ–¹ï¼‰ -->
<div class="stats-grid mb-4">
    <div class="stat-card">
        <div class="stat-label">ç•¶è¼ªç´¯è¨ˆç¥¨æˆ¿</div>
        <div class="stat-value">{{ statistics.total_boxoffice | format_currency }}</div>
        <div class="stat-change">
            è·¨è¼ªç´¯è¨ˆ {{ statistics.cross_round_total_boxoffice | format_currency }}
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-label">ç•¶è¼ªç´¯è¨ˆè§€å½±äººæ¬¡</div>
        <div class="stat-value">{{ statistics.total_audience | format_number }}</div>
        <div class="stat-change">
            è·¨è¼ªç´¯è¨ˆ {{ statistics.cross_round_total_audience | format_number }}
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-label">æœ€é«˜å‘¨ç¥¨æˆ¿</div>
        <div class="stat-value">{{ statistics.peak_boxoffice | format_currency }}</div>
        <div class="stat-change">
            ç•¶è¼ªçœŸå¯¦å‘¨æ¬¡ ç¬¬ {{ statistics.peak_week }} é€±
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-label">æœ¬å‘¨ç¥¨æˆ¿è¡°é€€ç‡</div>
        <div class="stat-value">{{ statistics.current_decline_rate | format_percentage }}</div>
        <div class="stat-change">
            è§€å½±äººæ¬¡ {{ statistics.audience_decline_rate | format_percentage }} / å ´æ¬¡æ•¸ {{ statistics.screens_decline_rate | format_percentage }}
        </div>
    </div>
</div>

<!-- æ•¸æ“šå‚™è¨» -->
<div class="alert alert-info mb-4">
    <span class="alert-icon">â„¹ï¸</span>
    <div class="alert-content">
        <div class="alert-message">æ˜ å¾Œä¸ƒæ—¥æ‰æœƒæœ‰çœŸå¯¦æ•¸æ“šï¼Œé—œæ–¼ã€Œæœ¬å‘¨ã€çš„çµ±è¨ˆæœƒæœ‰ç•°å‹•</div>
    </div>
</div>

<!-- åŸºæœ¬è³‡è¨Šå¡ç‰‡ -->
<div class="card mb-4">
    <div class="card-header">
        <h3 class="card-title">é›»å½±åŸºæœ¬è³‡è¨Š</h3>
    </div>
    <div class="card-body">
        <div class="info-list">
            <!-- åˆå§‹å±•é–‹çš„è³‡è¨Š -->
            <div class="info-item">
                <span class="info-label">ä¸Šæ˜ æ—¥æœŸ</span>
                <span class="info-value">{{ movie.release_date.strftime('%Yå¹´%mæœˆ%dæ—¥') }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">ç™¼è¡Œåœ‹å®¶</span>
                <span class="info-value">{{ movie.country }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">ç‰‡é•·</span>
                <span class="info-value">{{ movie.duration }} åˆ†é˜</span>
            </div>
            <div class="info-item">
                <span class="info-label">å°æ¼”</span>
                <span class="info-value">{{ movie.director }}</span>
            </div>

            <!-- å¯æ”¶åˆçš„è³‡è¨Š -->
            <div class="collapsible-section" id="moreInfo">
                <div class="info-item">
                    <span class="info-label">æ¼”å“¡</span>
                    <span class="info-value">{{ movie.actors | join(', ') }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ç™¼è¡Œå•†</span>
                    <span class="info-value">{{ movie.distributor }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">æ”¿åºœä»£è™Ÿ</span>
                    <span class="info-value">{{ movie.gov_id }}</span>
                </div>
            </div>
        </div>
        <button class="btn-collapse" id="toggleMoreInfo">
            <span class="collapse-text">å±•é–‹æ›´å¤š</span>
            <svg class="collapse-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
        </button>
    </div>
</div>

<!-- ç¥¨æˆ¿è¶¨å‹¢åœ–è¡¨ -->
<div class="chart-container">
    <div class="chart-header">
        <h3 class="chart-title">ç¥¨æˆ¿è¶¨å‹¢èˆ‡æœªä¾†é æ¸¬</h3>
        <div class="chart-actions">
            <button class="btn btn-secondary" onclick="chartUtils.exportChart('boxoffice-trend-chart', 'png')">
                ğŸ“¥ ä¸‹è¼‰åœ–è¡¨
            </button>
        </div>
    </div>
    <div class="chart-wrapper" id="boxoffice-trend-chart" 
         data-chart="boxoffice-trend" 
         data-chart-data='{{ chart_data | tojson }}'>
    </div>
</div>

<!-- é æ¸¬æ•¸æ“šè¡¨æ ¼ -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">ç¥¨æˆ¿é æ¸¬è©³ç´°æ•¸æ“š</h3>
        <div>
            <button class="btn btn-primary" data-export="excel" data-gov-id="{{ movie.gov_id }}">
                ğŸ“Š åŒ¯å‡º Excel
            </button>
            <button class="btn btn-secondary" data-export="csv" data-gov-id="{{ movie.gov_id }}">
                ğŸ“„ åŒ¯å‡º CSV
            </button>
        </div>
    </div>
    <div class="card-body">
        <table>
            <thead>
                <tr>
                    <th>é€±æ¬¡</th>
                    <th>é¡å‹</th>
                    <th>ç¥¨æˆ¿</th>
                    <th>è§€å½±äººæ•¸</th>
                    <th>å»³æ•¸</th>
                    <th>è¡°é€€ç‡</th>
                    <th>ç•°å¸¸è­¦ç¤º</th>
                </tr>
            </thead>
            <tbody>
                <!-- æ­·å²æ•¸æ“š -->
                {% for record in history %}
                <tr>
                    <td>ç¬¬{{ record.week }}é€±</td>
                    <td><span class="badge badge-success">å¯¦éš›</span></td>
                    <td>{{ record.boxoffice | format_currency }}</td>
                    <td>{{ record.audience | format_number }}</td>
                    <td>{{ record.screens }}</td>
                    <td>
                        {% if record.decline_rate %}
                            <span style="color: {{ record.decline_rate | decline_color }}">
                                {{ record.decline_rate | format_percentage }}
                            </span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>-</td>
                </tr>
                {% endfor %}

                <!-- é æ¸¬æ•¸æ“š -->
                {% for pred in predictions %}
                <tr style="background: rgba(156, 109, 255, 0.05);">
                    <td>ç¬¬{{ pred.week }}é€±</td>
                    <td><span class="badge badge-primary">é æ¸¬</span></td>
                    <td>{{ pred.predicted_boxoffice | format_currency }}</td>
                    <td>{{ (pred.predicted_boxoffice / 300) | int | format_number }}</td>
                    <td>-</td>
                    <td>
                        <span style="color: {{ pred.decline_rate | decline_color }}">
                            {{ pred.decline_rate | format_percentage }}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-success">âœ“ æ­£å¸¸</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- è¡°é€€ç‡åˆ†æåœ–è¡¨ -->
<div class="chart-container mt-4">
    <div class="chart-header">
        <h3 class="chart-title">é€±è¡°é€€ç‡åˆ†æ</h3>
    </div>
    <div class="chart-wrapper" id="decline-rate-chart" 
         data-chart="decline-rate" 
         data-chart-data='{{ decline_data | tojson }}'>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // åˆå§‹åŒ–åœ–è¡¨
    document.addEventListener('DOMContentLoaded', function() {
        // å¯ä»¥åœ¨æ­¤æ·»åŠ å³æ™‚æ›´æ–°åŠŸèƒ½
        // chartUtils.startRealtimeUpdate('{{ movie.gov_id }}', 60000);
    });
</script>
{% endblock %}
