{% extends "base.html" %}

{% block title %}{{ movie.title }} - ç¥¨æˆ¿é æ¸¬è©³æƒ…{% endblock %}

{% block content %}
<!-- é é¢æ¨™é¡Œ -->
<div class="mb-4">
    <h1>{{ movie.title }}</h1>
    <p class="text-secondary">ç¥¨æˆ¿é æ¸¬èˆ‡è¶¨å‹¢åˆ†æ</p>
</div>

<!-- é è­¦æç¤º -->
{% if warning.has_warning %}
<div class="alert alert-warning">
    <span class="alert-icon">âš </span>
    <div class="alert-content">
        <div class="alert-title">ç¥¨æˆ¿è¡°é€€é è­¦</div>
        <div class="alert-message">{{ warning.message }}</div>
    </div>
</div>
{% endif %}

<!-- åŸºæœ¬è³‡è¨Šå¡ç‰‡ -->
<div class="card mb-4">
    <div class="card-header">
        <h3 class="card-title">é›»å½±åŸºæœ¬è³‡è¨Š</h3>
        <span class="badge badge-primary">{{ movie.rating }}</span>
    </div>
    <div class="card-body">
        <div class="info-list">
            <div class="info-item">
                <span class="info-label">æ”¿åºœä»£è™Ÿ</span>
                <span class="info-value">{{ movie.gov_id }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">ç‰‡é•·</span>
                <span class="info-value">{{ movie.duration }} åˆ†é˜</span>
            </div>
            <div class="info-item">
                <span class="info-label">å°æ¼”</span>
                <span class="info-value">{{ movie.director }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">æ¼”å“¡</span>
                <span class="info-value">{{ movie.actors | join(', ') }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">ç™¼è¡Œåœ‹å®¶</span>
                <span class="info-value">{{ movie.country }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">ä¸Šæ˜ æ—¥æœŸ</span>
                <span class="info-value">{{ movie.release_date.strftime('%Yå¹´%mæœˆ%dæ—¥') }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">ç™¼è¡Œå•†</span>
                <span class="info-value">{{ movie.distributor }}</span>
            </div>
        </div>
    </div>
</div>

<!-- çµ±è¨ˆæ•¸æ“šå¡ç‰‡ -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">ç¸½ç¥¨æˆ¿</div>
        <div class="stat-value">{{ statistics.total_boxoffice | format_currency }}</div>
        <div class="stat-change positive">
            ç´¯è¨ˆ {{ statistics.weeks_released }} é€±
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">ç¸½è§€å½±äººæ•¸</div>
        <div class="stat-value">{{ statistics.total_audience | format_number }}</div>
        <div class="stat-change">
            å¹³å‡ç¥¨åƒ¹ NT$300
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">æœ€é«˜é€±ç¥¨æˆ¿</div>
        <div class="stat-value">{{ statistics.peak_boxoffice | format_currency }}</div>
        <div class="stat-change">
            ç¬¬ {{ statistics.peak_week }} é€±
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-label">å¹³å‡è¡°é€€ç‡</div>
        <div class="stat-value">{{ statistics.avg_decline_rate | format_percentage }}</div>
        <div class="stat-change {% if statistics.avg_decline_rate < -0.3 %}negative{% else %}positive{% endif %}">
            {{ 'æ­£å¸¸è¡°é€€' if statistics.avg_decline_rate > -0.3 else 'è¡°é€€è¼ƒå¿«' }}
        </div>
    </div>
</div>

<!-- ç¥¨æˆ¿è¶¨å‹¢åœ–è¡¨ -->
<div class="chart-container">
    <div class="chart-header">
        <h3 class="chart-title">ç¥¨æˆ¿è¶¨å‹¢èˆ‡æœªä¾†é æ¸¬</h3>
        <div class="chart-actions">
            <button class="btn btn-secondary" onclick="chartUtils.exportChart('boxoffice-trend-chart', 'png')">
                ğŸ“¥ ä¸‹è¼‰åœ–è¡¨
            </button>
        </div>
    </div>
    <div class="chart-wrapper" id="boxoffice-trend-chart" 
         data-chart="boxoffice-trend" 
         data-chart-data='{{ chart_data | tojson }}'>
    </div>
</div>

<!-- é æ¸¬æ•¸æ“šè¡¨æ ¼ -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">ç¥¨æˆ¿é æ¸¬è©³ç´°æ•¸æ“š</h3>
        <div>
            <button class="btn btn-primary" data-export="excel" data-gov-id="{{ movie.gov_id }}">
                ğŸ“Š åŒ¯å‡º Excel
            </button>
            <button class="btn btn-secondary" data-export="csv" data-gov-id="{{ movie.gov_id }}">
                ğŸ“„ åŒ¯å‡º CSV
            </button>
        </div>
    </div>
    <div class="card-body">
        <table>
            <thead>
                <tr>
                    <th>é€±æ¬¡</th>
                    <th>é¡å‹</th>
                    <th>ç¥¨æˆ¿</th>
                    <th>è§€å½±äººæ•¸</th>
                    <th>å»³æ•¸</th>
                    <th>è¡°é€€ç‡</th>
                    <th>ä¿¡å¿ƒå€é–“</th>
                </tr>
            </thead>
            <tbody>
                <!-- æ­·å²æ•¸æ“š -->
                {% for record in history %}
                <tr>
                    <td>ç¬¬{{ record.week }}é€±</td>
                    <td><span class="badge badge-success">å¯¦éš›</span></td>
                    <td>{{ record.boxoffice | format_currency }}</td>
                    <td>{{ record.audience | format_number }}</td>
                    <td>{{ record.screens }}</td>
                    <td>-</td>
                    <td>-</td>
                </tr>
                {% endfor %}
                
                <!-- é æ¸¬æ•¸æ“š -->
                {% for pred in predictions %}
                <tr style="background: rgba(156, 109, 255, 0.05);">
                    <td>ç¬¬{{ pred.week }}é€±</td>
                    <td><span class="badge badge-primary">é æ¸¬</span></td>
                    <td>{{ pred.predicted_boxoffice | format_currency }}</td>
                    <td>{{ (pred.predicted_boxoffice / 300) | int | format_number }}</td>
                    <td>-</td>
                    <td>
                        <span style="color: {{ pred.decline_rate | decline_color }}">
                            {{ pred.decline_rate | format_percentage }}
                        </span>
                    </td>
                    <td>
                        {{ pred.confidence_lower | format_currency }} ~ 
                        {{ pred.confidence_upper | format_currency }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- è¡°é€€ç‡åˆ†æåœ–è¡¨ -->
<div class="chart-container mt-4">
    <div class="chart-header">
        <h3 class="chart-title">é€±è¡°é€€ç‡åˆ†æ</h3>
    </div>
    <div class="chart-wrapper" id="decline-rate-chart" 
         data-chart="decline-rate" 
         data-chart-data='{{ decline_data | tojson }}'>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // åˆå§‹åŒ–åœ–è¡¨
    document.addEventListener('DOMContentLoaded', function() {
        // å¯ä»¥åœ¨æ­¤æ·»åŠ å³æ™‚æ›´æ–°åŠŸèƒ½
        // chartUtils.startRealtimeUpdate('{{ movie.gov_id }}', 60000);
    });
</script>
{% endblock %}
